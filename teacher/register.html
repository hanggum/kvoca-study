<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ ìƒë‹˜ íšŒì›ê°€ì… - ì–´íœ˜ë‚˜ë¼</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="../index.html" class="navbar-brand">âœ¨ ì–´íœ˜ë‚˜ë¼</a>
            <ul class="navbar-menu">
                <li><a href="login.html">ë¡œê·¸ì¸</a></li>
            </ul>
        </div>
    </nav>

    <!-- Register Section -->
    <section class="hero">
        <div class="container">
            <div class="glass-card" style="max-width: 600px; margin: 0 auto;">
                <div class="text-center mb-4">
                    <h1>ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ íšŒì›ê°€ì…</h1>
                    <p class="card-text">í•™ìƒë“¤ì˜ í•™ìŠµì„ ê´€ë¦¬í•  ì„ ìƒë‹˜ ê³„ì •ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
                </div>

                <form id="registerForm">
                    <div class="form-group">
                        <label class="form-label" for="school">í•™êµ ì´ë¦„ <span
                                style="color: var(--secondary-500);">*</span></label>
                        <input type="text" id="school" class="form-input" placeholder="ì˜ˆ: ì„œìš¸ì´ˆë“±í•™êµ" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="username">ì•„ì´ë”” <span
                                style="color: var(--secondary-500);">*</span></label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="username" class="form-input" placeholder="ì˜ë¬¸ 2ì ì´ìƒ, ìˆ«ì í—ˆìš©"
                                pattern="[a-zA-Z0-9]{2,}" required style="flex: 1;">
                            <button type="button" id="checkUsernameBtn" class="btn btn-outline"
                                style="white-space: nowrap; padding: 0 1rem;">
                                ì¤‘ë³µ í™•ì¸
                            </button>
                        </div>
                        <small id="usernameHelp"
                            style="color: var(--text-muted); font-size: 0.8rem; display: block; margin-top: 0.25rem;">
                            ì˜ë¬¸ì 2ì ì´ìƒ, ìˆ«ì ì‚¬ìš© ê°€ëŠ¥
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="grade">ë‹´ë‹¹ í•™ë…„ <span
                                style="color: var(--secondary-500);">*</span></label>
                        <select id="grade" class="form-input" required>
                            <option value="">í•™ë…„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="1">1í•™ë…„</option>
                            <option value="2">2í•™ë…„</option>
                            <option value="3">3í•™ë…„</option>
                            <option value="4">4í•™ë…„</option>
                            <option value="5">5í•™ë…„</option>
                            <option value="6">6í•™ë…„</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="nickname">ë³„ëª… <span
                                style="color: var(--secondary-500);">*</span></label>
                        <input type="text" id="nickname" class="form-input" placeholder="ì˜ˆ: ê¹€ì„ ìƒë‹˜" required>
                        <small
                            style="color: var(--text-muted); font-size: 0.8rem; display: block; margin-top: 0.25rem;">
                            í•™ìƒë“¤ì—ê²Œ í‘œì‹œë  ì´ë¦„ì…ë‹ˆë‹¤
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="password">ë¹„ë°€ë²ˆí˜¸ <span
                                style="color: var(--secondary-500);">*</span></label>
                        <input type="password" id="password" class="form-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="passwordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span
                                style="color: var(--secondary-500);">*</span></label>
                        <input type="password" id="passwordConfirm" class="form-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                            required>
                    </div>

                    <div id="errorMessage" class="hidden"
                        style="color: var(--secondary-500); margin-bottom: 1rem; text-align: center;"></div>

                    <div id="successMessage" class="hidden"
                        style="color: var(--success-500); margin-bottom: 1rem; text-align: center; padding: 1rem; background: var(--bg-dark-tertiary); border-radius: var(--radius-md);">
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        íšŒì›ê°€ì…
                    </button>
                </form>

                <div class="mt-3 text-center">
                    <p style="font-size: 0.875rem; color: var(--text-muted);">
                        ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="login.html" style="color: var(--primary-400);">ë¡œê·¸ì¸</a>
                    </p>
                </div>
            </div>

            <!-- Info Cards -->
            <div class="grid grid-3 mt-5" style="max-width: 900px; margin-left: auto; margin-right: auto;">
                <div class="card text-center">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ”</div>
                    <h4>ì•ˆì „í•œ ê³„ì •</h4>
                    <p class="card-text" style="font-size: 0.875rem;">
                        ê°œì¸ì •ë³´ëŠ”<br>ì•ˆì „í•˜ê²Œ ë³´í˜¸ë©ë‹ˆë‹¤
                    </p>
                </div>
                <div class="card text-center">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ‘¥</div>
                    <h4>í•™ìƒ ê´€ë¦¬</h4>
                    <p class="card-text" style="font-size: 0.875rem;">
                        ì†ì‰¬ìš´ í•™ìƒ<br>ê³„ì • ê´€ë¦¬
                    </p>
                </div>
                <div class="card text-center">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“Š</div>
                    <h4>í•™ìŠµ ë¶„ì„</h4>
                    <p class="card-text" style="font-size: 0.875rem;">
                        ì‹¤ì‹œê°„ í•™ìŠµ<br>í˜„í™© íŒŒì•…
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Config & Data Service -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/data-service.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        const registerForm = document.getElementById('registerForm');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const usernameInput = document.getElementById('username');
        const checkUsernameBtn = document.getElementById('checkUsernameBtn');
        const usernameHelp = document.getElementById('usernameHelp');

        let isUsernameChecked = false;
        let lastCheckedUsername = '';

        // Username input validation
        // Username input validation
        usernameInput.addEventListener('input', (e) => {
            const value = e.target.value;

            // Reset check status if username changed
            if (value !== lastCheckedUsername) {
                isUsernameChecked = false;

                // Live validation feedback
                if (/[^a-zA-Z0-9]/.test(value)) {
                    usernameHelp.style.color = 'var(--secondary-500)';
                    usernameHelp.textContent = 'ì˜ë¬¸ìì™€ ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤. (í•œê¸€ ì…ë ¥ ë¶ˆê°€)';
                } else {
                    usernameHelp.style.color = 'var(--text-muted)';
                    usernameHelp.textContent = 'ì˜ë¬¸ì 2ì ì´ìƒ, ìˆ«ì ì‚¬ìš© ê°€ëŠ¥';
                }
            }
        });

        // Check username duplicate
        checkUsernameBtn.addEventListener('click', async () => {
            const username = usernameInput.value.trim();

            // Validation
            if (!username) {
                usernameHelp.style.color = 'var(--secondary-500)';
                usernameHelp.textContent = 'ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }

            if (username.length < 2) {
                usernameHelp.style.color = 'var(--secondary-500)';
                usernameHelp.textContent = 'ì•„ì´ë””ëŠ” ìµœì†Œ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                return;
            }


            if (!/^[a-zA-Z]/.test(username)) {
                usernameHelp.style.color = 'var(--secondary-500)';
                usernameHelp.textContent = 'ì•„ì´ë””ëŠ” ì˜ë¬¸ìë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.';
                return;
            }

            if (/[^a-zA-Z0-9]/.test(username)) {
                usernameHelp.style.color = 'var(--secondary-500)';
                usernameHelp.textContent = 'ì˜ë¬¸ìì™€ ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }

            // Check duplicate
            checkUsernameBtn.disabled = true;
            checkUsernameBtn.textContent = 'í™•ì¸ ì¤‘...';

            try {
                await dbService.init();
                const existingUser = await dbService.getUser('username', username);

                if (existingUser) {
                    usernameHelp.style.color = 'var(--secondary-500)';
                    usernameHelp.textContent = 'âŒ ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.';
                    isUsernameChecked = false;
                } else {
                    usernameHelp.style.color = 'var(--success-500)';
                    usernameHelp.textContent = 'âœ… ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.';
                    isUsernameChecked = true;
                    lastCheckedUsername = username;
                }
            } catch (error) {
                usernameHelp.style.color = 'var(--secondary-500)';
                usernameHelp.textContent = 'ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                isUsernameChecked = false;
            } finally {
                checkUsernameBtn.disabled = false;
                checkUsernameBtn.textContent = 'ì¤‘ë³µ í™•ì¸';
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Hide previous messages
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');

            const username = usernameInput.value.trim();
            const school = document.getElementById('school').value.trim();
            const grade = document.getElementById('grade').value;
            const nickname = document.getElementById('nickname').value.trim();
            const password = document.getElementById('password').value;
            const passwordConfirm = document.getElementById('passwordConfirm').value;

            // Validation
            if (!username || !school || !grade || !nickname || !password) {
                errorMessage.textContent = 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                errorMessage.classList.remove('hidden');
                return;
            }

            if (!isUsernameChecked || username !== lastCheckedUsername) {
                errorMessage.textContent = 'ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”.';
                errorMessage.classList.remove('hidden');
                usernameHelp.style.color = 'var(--secondary-500)';
                usernameHelp.textContent = 'âš ï¸ ì¤‘ë³µ í™•ì¸ í•„ìš”';
                return;
            }

            if (password !== passwordConfirm) {
                errorMessage.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                errorMessage.classList.remove('hidden');
                return;
            }

            if (password.length < 4) {
                errorMessage.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                errorMessage.classList.remove('hidden');
                return;
            }

            // Register teacher
            const result = await auth.registerTeacher({
                username: username,
                school: school,
                grade: grade,
                nickname: nickname,
                password: password
            });

            if (result.success) {
                // Show success message with teacher code
                successMessage.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <strong>âœ… íšŒì›ê°€ì… ì„±ê³µ!</strong>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        ì„ ìƒë‹˜ ì½”ë“œ: <strong style="font-size: 1.5rem; color: var(--primary-400); font-family: monospace;">${result.teacherCode}</strong>
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                        ì´ ì½”ë“œë¥¼ í•™ìƒë“¤ì—ê²Œ ì•Œë ¤ì£¼ì„¸ìš”!
                    </div>
                    <div style="margin-top: 1rem;">
                        <button onclick="window.location.href='login.html'" class="btn btn-secondary" style="width: 100%;">
                            ë¡œê·¸ì¸í•˜ëŸ¬ ê°€ê¸°
                        </button>
                    </div>
                `;
                successMessage.classList.remove('hidden');

                // Clear form
                registerForm.reset();
            } else {
                // Show error
                errorMessage.textContent = result.message;
                errorMessage.classList.remove('hidden');

                // Shake animation
                registerForm.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    registerForm.style.animation = '';
                }, 500);
            }
        });

        // Add shake animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
                20%, 40%, 60%, 80% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>