<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ - ì–´íœ˜ë‚˜ë¼</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Gamja+Flower&family=Nanum+Myeongjo&display=swap"
        rel="stylesheet">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="../index.html" class="navbar-brand">âœ¨ ì–´íœ˜ë‚˜ë¼</a>
            <ul class="navbar-menu">
                <li><a href="dashboard.html" class="navbar-link">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><span id="userName" class="navbar-link"></span></li>
                <li><button onclick="showSettingsModal()" class="btn btn-outline btn-sm"
                        style="margin-right: 0.5rem;">âš™ï¸ ì„¤ì •</button></li>
                <li><button onclick="auth.logout()" class="btn btn-outline btn-sm">ë¡œê·¸ì•„ì›ƒ</button></li>
            </ul>
        </div>
    </nav>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal" style="z-index: 3000;">
        <div class="modal" style="position: relative;">
            <button class="modal-close" onclick="closeSettingsModal()">Ã—</button>
            <div class="modal-header">
                <h2 class="modal-title">í™˜ê²½ ì„¤ì •</h2>
                <p style="color: #666;">ì„ ìƒë‹˜ ë§ì¶¤í˜• ì„¤ì •ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
            </div>

            <form id="settingsForm">
                <div class="form-group">
                    <label class="form-label">í•™êµ ì´ë¦„</label>
                    <input type="text" id="settingSchoolName" class="form-input" placeholder="ì˜ˆ: ì„œìš¸ì´ˆë“±í•™êµ">
                </div>

                <div class="form-group">
                    <label class="form-label">í•™ê¸‰ ì´ë¦„</label>
                    <input type="text" id="settingClassName" class="form-input" placeholder="ì˜ˆ: 3í•™ë…„ 2ë°˜">
                </div>

                <div class="form-group">
                    <label class="form-label">ê¸°ë³¸ í•™ë…„ ì„¤ì •</label>
                    <select id="settingDefaultGrade" class="form-input">
                        <option value="">ì„ íƒ ì•ˆí•¨</option>
                        <option value="1">1í•™ë…„</option>
                        <option value="2">2í•™ë…„</option>
                        <option value="3">3í•™ë…„</option>
                        <option value="4">4í•™ë…„</option>
                        <option value="5">5í•™ë…„</option>
                        <option value="6">6í•™ë…„</option>
                    </select>
                    <small style="color: #888;">í•™ìƒ ì¶”ê°€ë‚˜ ì›Œí¬ì‹œíŠ¸ ìƒì„± ì‹œ ì´ í•™ë…„ì´ ê¸°ë³¸ ì„ íƒë©ë‹ˆë‹¤.</small>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                    ì„¤ì • ì €ì¥í•˜ê¸°
                </button>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <section class="container mt-4 mb-5">
        <!-- Welcome Section -->
        <div class="glass-card mb-4" style="padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1rem;">
            <h2 id="welcomeMessage" style="margin: 0; font-size: 1.5rem;"></h2>
            <div style="width: 1px; height: 20px; background: #ccc;"></div>
            <p class="card-text" style="margin: 0; font-size: 1rem;">í•™ìƒë“¤ì˜ í•™ìŠµì„ ê´€ë¦¬í•˜ê³  ì§€ì›í•˜ì„¸ìš” ğŸ“Š</p>
            <div
                style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--primary-600); border-radius: var(--radius-md);">
                <span style="font-size: 0.875rem; color: var(--text-secondary);">ì„ ìƒë‹˜ ì½”ë“œ</span>
                <span id="teacherCode"
                    style="font-size: 1.25rem; font-weight: bold; color: var(--text-primary); font-family: monospace;"></span>
                <button id="copyCodeBtn" onclick="copyTeacherCode()"
                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem; border: 1px solid var(--primary-400); background: transparent; color: var(--text-primary); border-radius: var(--radius-sm); cursor: pointer;">
                    ë³µì‚¬
                </button>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-4 mb-4">
            <div class="card stats-card" style="padding: 1rem;">
                <div class="stats-number" id="totalStudents" style="font-size: 2rem; margin-bottom: 0;">0</div>
                <div class="stats-label" style="font-size: 0.9rem;">ì „ì²´ í•™ìƒ</div>
            </div>

            <div class="card stats-card" style="padding: 1rem;">
                <div class="stats-number" id="activeToday" style="font-size: 2rem; margin-bottom: 0;">0</div>
                <div class="stats-label" style="font-size: 0.9rem;">ì˜¤ëŠ˜ í™œë™</div>
            </div>

            <div class="card stats-card" style="padding: 1rem;">
                <div class="stats-number" id="totalVocab" style="font-size: 2rem; margin-bottom: 0;">0</div>
                <div class="stats-label" style="font-size: 0.9rem;">ì–´íœ˜ ìˆ˜</div>
            </div>

            <div class="card stats-card" style="padding: 1rem;">
                <div class="stats-number" id="avgProgress" style="font-size: 2rem; margin-bottom: 0;">0%</div>
                <div class="stats-label" style="font-size: 0.9rem;">í‰ê·  ì§„ë„</div>
            </div>
        </div>



        </div>

        <!-- Today's Learning Status -->
        <!-- Today's Learning Status -->
        <div class="glass-card mb-4">
            <!-- Calendar Strip -->
            <div class="calendar-strip mb-3" id="calendarStrip"
                style="display: grid; grid-template-columns: repeat(14, 1fr); gap: 0px; row-gap: 0px;">
                <!-- Filled by JS -->
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin:0; font-size: 1.5rem;" id="learningStatusTitle">ğŸ“… ì˜¤ëŠ˜ì˜ í•™ìŠµ í˜„í™©</h2>
                <div style="font-size: 0.9rem; color: #ccc;" id="learningStatusDate">${new Date().toLocaleDateString()}
                    ê¸°ì¤€</div>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; color: #eee;">
                    <thead>
                        <tr style="border-bottom: 2px solid rgba(255,255,255,0.2); text-align: left;">
                            <th style="padding: 12px;">í•™ìƒ ì´ë¦„</th>
                            <th style="padding: 12px; text-align: center;">ì ‘ì†</th>
                            <th style="padding: 12px; text-align: center;">í”Œë˜ì‹œì¹´ë“œ</th>
                            <th style="padding: 12px; text-align: center;">ë”°ë¼ì“°ê¸°</th>
                            <th style="padding: 12px; text-align: center;">ë¬¸ì¥ë§Œë“¤ê¸°</th>
                            <th style="padding: 12px; text-align: center; color: #ff9a9e;">ë¯¸ì œì¶œ</th>
                            <th style="padding: 12px; text-align: center; color: #4facfe;">ì œì¶œ</th>
                        </tr>
                    </thead>
                    <tbody id="dailyProgressTable">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Quick Actions -->
        <h2 class="mb-3">âš¡ ë¹ ë¥¸ ì‘ì—…</h2>
        <div class="grid grid-3 mb-4">
            <div class="card" style="cursor: pointer;" onclick="showWorksheetModal()">
                <div style="font-size: 3rem; text-align: center; margin-bottom: 1rem;">ğŸ“</div>
                <h3 class="card-title">ì›Œí¬ì‹œíŠ¸ ìƒì„±</h3>
                <p class="card-text">
                    í•™ë…„ë³„ ë§ì¶¤ ì›Œí¬ì‹œíŠ¸ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
                </p>
                <span class="badge badge-success">ì‚¬ìš©ê°€ëŠ¥</span>
            </div>

            <div class="card" style="cursor: pointer;" onclick="showQuizModal()">
                <div style="font-size: 3rem; text-align: center; margin-bottom: 1rem;">ğŸ¯</div>
                <h3 class="card-title">í€´ì¦ˆ ìƒì„±</h3>
                <p class="card-text">
                    ì„ íƒí•œ ì–´íœ˜ë¡œ í€´ì¦ˆë¥¼ ìë™ ìƒì„±í•˜ê³  ë°°í¬í•©ë‹ˆë‹¤.
                </p>
                <span class="badge badge-primary">ì‚¬ìš©ê°€ëŠ¥</span>
            </div>

            <div class="card" style="cursor: pointer;" onclick="showVocabularyManager()">
                <div style="font-size: 3rem; text-align: center; margin-bottom: 1rem;">ğŸ“š</div>
                <h3 class="card-title">ì–´íœ˜ ê´€ë¦¬</h3>
                <p class="card-text">
                    ì–´íœ˜ë¥¼ ì¶”ê°€, ìˆ˜ì •, ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <span class="badge badge-success">ì‚¬ìš©ê°€ëŠ¥</span>
            </div>

            <div class="card" style="cursor: pointer;" onclick="showSavedWorksheetsModal()">
                <div style="font-size: 3rem; text-align: center; margin-bottom: 1rem;">ğŸ“</div>
                <h3 class="card-title">ì €ì¥ëœ í•™ìŠµì§€</h3>
                <p class="card-text">
                    ì´ì „ì— ìƒì„±í•œ í•™ìŠµì§€ ëª©ë¡ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì¸ì‡„í•©ë‹ˆë‹¤.
                </p>
                <span class="badge badge-primary">New</span>
            </div>

            <div class="card" style="cursor: pointer;" onclick="showDistributedWorksheets()">
                <div style="font-size: 3rem; text-align: center; margin-bottom: 1rem;">ğŸ“¨</div>
                <h3 class="card-title">ë°°í¬ ê´€ë¦¬</h3>
                <p class="card-text">
                    í•™ìƒë“¤ì—ê²Œ ë°°í¬í•œ í•™ìŠµì§€ì˜ ì œì¶œ í˜„í™©ì„ í™•ì¸í•˜ê³  ì±„ì í•©ë‹ˆë‹¤.
                </p>
                <span class="badge badge-success">New</span>
            </div>

            <div class="card" style="cursor: pointer;" onclick="showStudentManagementModal()">
                <div style="font-size: 3rem; text-align: center; margin-bottom: 1rem;">ğŸ‘¥</div>
                <h3 class="card-title">í•™ìƒ ê´€ë¦¬</h3>
                <p class="card-text">
                    í•™ìƒ ëª©ë¡ì„ í™•ì¸í•˜ê³  ê³„ì •ì„ ì¶”ê°€/ê´€ë¦¬í•©ë‹ˆë‹¤.
                </p>
                <span class="badge badge-primary">ê´€ë¦¬</span>
            </div>
            <div class="card" style="cursor: pointer;" onclick="showDailyPlanModal()">
                <div style="font-size: 3rem; text-align: center; margin-bottom: 1rem;">ğŸ“…</div>
                <h3 class="card-title">ì˜¤ëŠ˜ì˜ ë‹¨ì–´ ê´€ë¦¬</h3>
                <p class="card-text">
                    ë‚ ì§œë³„ í•™ìŠµ ë‹¨ì–´ë¥¼ ì§€ì •í•˜ê³  ìˆ˜ì •í•©ë‹ˆë‹¤.
                </p>
                <span class="badge badge-primary">New</span>
            </div>
            <div class="card" style="cursor: pointer;" onclick="showCsvGeneratorModal()">
                <div style="font-size: 3rem; text-align: center; margin-bottom: 1rem;">ğŸ“</div>
                <h3 class="card-title">CSV ë°ì´í„° ìƒì„±ê¸°</h3>
                <p class="card-text">
                    ìƒˆ ì–´íœ˜ ì¶”ê°€ë¥¼ ìœ„í•œ CSV í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ì‰½ê²Œ ìƒì„±í•©ë‹ˆë‹¤.
                </p>
                <span class="badge badge-success">Tool</span>
            </div>
        </div>

        <!-- Daily Plan Manager Modal -->
        <div class="modal-overlay" id="dailyPlanModal">
            <div class="modal" style="position: relative; max-width: 600px;">
                <button class="modal-close" onclick="closeDailyPlanModal()">Ã—</button>
                <div class="modal-header">
                    <h2 class="modal-title">ì˜¤ëŠ˜ì˜ ë‹¨ì–´ ê´€ë¦¬</h2>
                </div>
                <div class="form-group">
                    <label class="form-label">ë‚ ì§œ ì„ íƒ</label>
                    <input type="date" id="planDate" class="form-input" onchange="loadPlanForEditor()">
                </div>
                <div class="form-group">
                    <label class="form-label">í•™ë…„ ì„ íƒ</label>
                    <select id="planGrade" class="form-input" onchange="loadPlanForEditor()">
                        <option value="1">1í•™ë…„</option>
                        <option value="2">2í•™ë…„</option>
                        <option value="3">3í•™ë…„</option>
                        <option value="4">4í•™ë…„</option>
                        <option value="5">5í•™ë…„</option>
                        <option value="6">6í•™ë…„</option>
                    </select>
                </div>

                <div class="mb-3">
                    <h3 style="font-size: 1.2rem; margin-bottom: 0.5rem;">ì„ íƒëœ ë‹¨ì–´ (2ê°œ)</h3>
                    <div id="planWordsList"
                        style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                        <!-- Words will be injected here -->
                        <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”
                            ì¤‘...</div>
                    </div>
                    <button onclick="openWordSearchForPlan()" class="btn btn-outline btn-sm" style="width: 100%;">+ ë‹¨ì–´
                        ë³€ê²½/ê²€ìƒ‰</button>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" onclick="closeDailyPlanModal()" class="btn btn-outline" style="flex: 1;">
                        ë‹«ê¸°
                    </button>
                    <button type="button" onclick="savePlanFromEditor()" class="btn btn-primary" style="flex: 1;">
                        ì €ì¥í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Add Student Modal -->
    <div class="modal-overlay" id="addStudentModal" style="z-index: 2000;">
        <div class="modal" style="position: relative;">
            <button class="modal-close" onclick="closeAddStudentModal()">Ã—</button>
            <div class="modal-header">
                <h2 class="modal-title">í•™ìƒ ì¶”ê°€</h2>
            </div>
            <form id="addStudentForm">
                <div class="form-group">
                    <label class="form-label" for="studentName">ì´ë¦„</label>
                    <input type="text" id="studentName" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="studentUsername">ì•„ì´ë””</label>
                    <input type="text" id="studentUsername" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="studentPassword">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="studentPassword" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="studentGrade">í•™ë…„</label>
                    <select id="studentGrade" class="form-input" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="1">1í•™ë…„</option>
                        <option value="2">2í•™ë…„</option>
                        <option value="3">3í•™ë…„</option>
                        <option value="4">4í•™ë…„</option>
                        <option value="5">5í•™ë…„</option>
                        <option value="6">6í•™ë…„</option>
                    </select>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button type="button" onclick="closeAddStudentModal()" class="btn btn-outline" style="flex: 1;">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        ì¶”ê°€í•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Vocabulary Manager Modal -->
    <div class="modal-overlay" id="vocabModal">
        <div class="modal" style="position: relative; max-width: 800px;">
            <button class="modal-close" onclick="closeVocabModal()">Ã—</button>
            <div class="modal-header">
                <h2 class="modal-title">ì–´íœ˜ ê´€ë¦¬</h2>
            </div>
            <div id="vocabContent">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Config & Data Service -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/data-service.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/hanja-data.js"></script>
    <script src="../js/hanja-compounds.js"></script>
    <script src="../js/vocab-data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <script src="../js/worksheet-renderer.js"></script>
    <script>
        // Check authentication
        if (!auth.requireAuth('teacher')) {
            window.location.href = 'login.html';
        }

        const user = auth.getCurrentUser();
        document.getElementById('welcomeMessage').textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${user.name}ë‹˜! ğŸ‘‹`;
        document.getElementById('userName').textContent = user.name;

        // Display teacher code
        if (user.teacherCode) {
            document.getElementById('teacherCode').textContent = user.teacherCode;
        }

        // Function to copy teacher code to clipboard
        function copyTeacherCode() {
            const code = user.teacherCode;
            if (code) {
                navigator.clipboard.writeText(code).then(() => {
                    const btn = document.getElementById('copyCodeBtn');
                    const originalText = btn.textContent;
                    btn.textContent = 'ë³µì‚¬ë¨!';
                    btn.style.background = 'var(--success-500)';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = 'transparent';
                    }, 2000);
                }).catch(err => {
                    alert('ì½”ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                });
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            const students = await auth.getStudents();

            // Update stats
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('totalVocab').textContent = vocabDB.vocabulary.length;

            // Calculate average progress
            if (students.length > 0) {
                const totalProgress = students.reduce((sum, student) => {
                    const progress = student.progress || {};
                    return sum + (progress.flashcardsCompleted || 0) +
                        (progress.typingCompleted || 0) +
                        (progress.writingCompleted || 0);
                }, 0);
                const avgProgress = Math.round(totalProgress / students.length / 3);
                document.getElementById('avgProgress').textContent = avgProgress + '%';
            }

            // Render Daily Progress
            initCalendar();
            await renderDailyProgress();
        }

        // Calendar & Daily Selection
        let selectedDate = new Date();
        let currentCalendarDate = new Date(); // Track displayed month

        function changeMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            initCalendar();
        }

        function selectDate(dateStr) {
            selectedDate = new Date(dateStr);
            // Don't auto-jump calendar if selecting a date (unless we want to? e.g. if we pick from another view).
            // But here we pick FROM calendar mostly.
            initCalendar();
            renderDailyProgress(selectedDate);

            // Update Title Date
            const options = { month: 'long', day: 'numeric', weekday: 'long' };
            const formatted = selectedDate.toLocaleDateString('ko-KR', options);
            document.getElementById('learningStatusDate').textContent = `${formatted} ê¸°ì¤€`;
        }

        function initCalendar() {
            const calendarStrip = document.getElementById('calendarStrip');
            if (!calendarStrip) return;

            const today = new Date();

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth(); // 0-indexed

            // Get days in month
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayDow = new Date(year, month, 1).getDay(); // 0(Sun) to 6(Sat)

            let html = '';

            // Add Month Header with Nav
            html += `<div style="grid-column: 1 / -1; display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 5px; color: var(--text-primary); font-size: 1.1rem;">
                <button onclick="changeMonth(-1)" class="btn btn-sm btn-outline" style="padding: 2px 8px; border: none; background: rgba(255,255,255,0.1);">â—€</button>
                <span style="font-weight: bold;">${year}ë…„ ${month + 1}ì›”</span>
                <button onclick="changeMonth(1)" class="btn btn-sm btn-outline" style="padding: 2px 8px; border: none; background: rgba(255,255,255,0.1);">â–¶</button>
            </div>`;

            // Header Row (Days of Week x 2 for 14 cols)
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            dayNames.push(...dayNames);

            dayNames.forEach(name => {
                html += `<div style="text-align: center; font-size: 0.9rem; font-weight: bold; color: var(--text-secondary); padding-bottom: 0px;">${name}</div>`;
            });

            // Spacers for 1st day alignment
            for (let i = 0; i < firstDayDow; i++) {
                html += `<div></div>`;
            }

            for (let d = 1; d <= daysInMonth; d++) {
                // Check if matches today
                const isToday = (d === today.getDate() && month === today.getMonth() && year === today.getFullYear());
                // Check if matches selected
                const isSelected = (d === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear());

                // Base style
                let style = 'width: 100%; display: flex; align-items: center; justify-content: center; padding: 0px; aspect-ratio: 1.6; border: none; background: transparent; color: var(--text-primary); cursor: pointer; border-radius: 4px;';

                if (isSelected) {
                    style += ' background: var(--primary-color); color: white;';
                }

                if (isToday) {
                    style = style.replace('border: none;', '');
                    style += ` border: 2px solid ${isSelected ? 'white' : 'var(--accent-color, #ff6b6b)'}; box-shadow: 0 0 0 1px ${isSelected ? 'transparent' : 'var(--accent-color, #ff6b6b)'};`;
                }

                html += `
                    <button onclick="selectDate('${year}-${month + 1}-${d}')" style="${style}">
                        <span style="font-weight: bold; font-size: 1.1rem;">${d}</span>
                    </button>
                `;
            }

            calendarStrip.innerHTML = html;
        }

        async function renderDailyProgress(targetDate = new Date()) {
            const tableBody = document.getElementById('dailyProgressTable');
            if (!tableBody) return;

            // Use auth.getStudents() to filter by teacher
            const students = await auth.getStudents();
            const history = await dbService.getAllStudyHistory();
            const assignments = await dbService.getAssignments();
            const submissions = await dbService.getSubmissions();

            // Target Date Range (00:00 to 23:59)
            const startOfDay = new Date(targetDate);
            startOfDay.setHours(0, 0, 0, 0);

            const endOfDay = new Date(targetDate);
            endOfDay.setHours(23, 59, 59, 999);

            if (students.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #999;">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            const html = students.map(student => {
                // Access Status & Activities (Target Date)
                const studentHistory = history.filter(h => {
                    // Check userId
                    const isUser = (h.userId === student.id || h.userId === student.username);
                    const hDate = new Date(h.timestamp);
                    return isUser && hDate >= startOfDay && hDate <= endOfDay;
                });

                const isLoggedIn = studentHistory.length > 0;
                const accessStatus = isLoggedIn ? '<span style="color: #4facfe;">â— ì ‘ì†</span>' : '<span style="color: #666;">â—‹ ë¯¸ì ‘ì†</span>';

                const flashcardCount = studentHistory.filter(h => h.type === 'flashcard').length;
                const typingCount = studentHistory.filter(h => h.type === 'typing').length;
                const writingCount = studentHistory.filter(h => h.type === 'writing').length;

                // Submissions (Total Pending/Submitted is weird for "Daily" view, but maybe "Submitted Today"?)
                // The table headers are "Pending" and "Submitted". Usually implies ALL time or current status.
                // If the user scrolls back to yesterday, should "Pending" show yesterday's pending? 
                // Assignment status is stateful, not historical usually.
                // But submissions have timestamp.
                // Let's keep Unsubmitted as current total (state) but maybe highlight submissions from THAT day?
                // Or just show total. The request is "Learning Status".
                // I will show Total Unsubmitted (Current) and Total Submitted (Current).
                // Or "Submitted ON that day"?
                // "ì œì¶œ" col usually means count.
                // Let's count submissions made ON that date.

                const mySubmissions = submissions.filter(s => {
                    const sDate = new Date(s.timestamp || 0); // submissions usually have timestamp
                    // If submission doesn't have timestamp (local impl might miss it?), assume no match if filtering by date.
                    // But our saveSubmission usually adds date? 
                    // Let's check logic. dbService doesn't enforce timestamp in saveSubmission but it's good practice.
                    // Assuming saveSubmission adds it or the logic creating usage adds it.
                    // For now, let's filter mySubmissions by Student first.
                    let isMySub = false;
                    if (s.studentId) isMySub = (s.studentId === student.id || s.studentId === student.username);
                    else isMySub = (s.studentName === student.name);

                    if (!isMySub) return false;

                    if (s.submittedAt || s.timestamp) {
                        const d = new Date(s.submittedAt || s.timestamp);
                        return d >= startOfDay && d <= endOfDay;
                    }
                    return false;
                });

                const totalAssignments = assignments.length;
                // Unsubmitted is "Total Assigned - Total Submitted Ever" usually.
                // Showing "Unsubmitted" for a past date is confusing. 
                // I will show "Submitted Today: X". 
                // Unsubmitted: Just show current Pending? Or "-" if past date?
                // Let's keep it simple: Show assignments submitted ON that day. Use ' - ' for unsubmitted column if strictly daily view, or just show current backlog.
                // User probably wants to see "Did they do the work THAT day?"
                // I will show "Submission Count (That Day)".

                const submittedCount = mySubmissions.length;

                return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 12px; font-weight: 500;">${student.name}</td>
                        <td style="padding: 12px; text-align: center;">${accessStatus}</td>
                        <td style="padding: 12px; text-align: center;">${flashcardCount > 0 ? 'âœ…' : '<span style="color:#666">-</span>'}</td>
                        <td style="padding: 12px; text-align: center;">${typingCount > 0 ? 'âœ…' : '<span style="color:#666">-</span>'}</td>
                        <td style="padding: 12px; text-align: center;">${writingCount > 0 ? 'âœ…' : '<span style="color:#666">-</span>'}</td>
                        <td style="padding: 12px; text-align: center;"><span style="color: #666;">-</span></td>
                        <td style="padding: 12px; text-align: center;"><span style="color: #4facfe; font-weight: bold;">${submittedCount}ê±´</span></td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = html;
        }

        // Load students list
        function loadStudentsList() {
            const students = auth.getStudents();
            const studentsListDiv = document.getElementById('studentsList');

            if (students.length === 0) {
                studentsListDiv.innerHTML = `
                    <p class="card-text text-center" style="padding: 2rem;">
                        ì•„ì§ ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤. í•™ìƒì„ ì¶”ê°€í•´ë³´ì„¸ìš”!
                    </p>
                `;
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';

            students.forEach(student => {
                const progress = student.progress || {};
                const totalCompleted = (progress.flashcardsCompleted || 0) +
                    (progress.typingCompleted || 0) +
                    (progress.writingCompleted || 0);

                html += `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                            <div style="flex: 1;">
                                <h3>${student.name}</h3>
                                <p class="card-text">
                                    <span class="badge badge-primary">${student.grade}í•™ë…„</span>
                                    <span style="margin-left: 0.5rem; color: var(--text-muted);">
                                        ì•„ì´ë””: ${student.username}
                                    </span>
                                </p>
                                <div style="margin-top: 1rem; display: flex; gap: 2rem; flex-wrap: wrap;">
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-muted);">í”Œë˜ì‹œì¹´ë“œ</div>
                                        <div style="font-weight: 600;">${progress.flashcardsCompleted || 0}ê°œ</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-muted);">íƒ€ì´í•‘</div>
                                        <div style="font-weight: 600;">${progress.typingCompleted || 0}ê°œ</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-muted);">ë¬¸ì¥ ë§Œë“¤ê¸°</div>
                                        <div style="font-weight: 600;">${progress.writingCompleted || 0}ê°œ</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-muted);">ì´ í•™ìŠµ</div>
                                        <div style="font-weight: 600; color: var(--primary-500);">${totalCompleted}ê°œ</div>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="viewStudentDetail('${student.id}')" class="btn btn-sm btn-outline">
                                    ìƒì„¸ë³´ê¸°
                                </button>
                                <button onclick="deleteStudent('${student.id}', '${student.name}')" class="btn btn-sm btn-secondary">
                                    ì‚­ì œ
                                </button>
                            </div>
                        </div>
                        <div class="progress-bar mt-3">
                            <div class="progress-fill" style="width: ${Math.min(totalCompleted, 100)}%"></div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            studentsListDiv.innerHTML = html;
        }

        let editingStudentId = null;

        // Show add student modal
        function showAddStudentModal() {
            editingStudentId = null;
            document.getElementById('addStudentModal').classList.add('active');
            document.querySelector('#addStudentModal .modal-title').textContent = 'í•™ìƒ ì¶”ê°€';
            document.querySelector('#addStudentForm button[type="submit"]').textContent = 'ì¶”ê°€í•˜ê¸°';
            document.getElementById('studentUsername').readOnly = false;
        }

        // Show edit student modal
        window.showEditStudentModal = async function (username) {
            // alert('Edit Triggered: ' + username); // Debug
            try {
                await dbService.init();
                const users = await dbService.getUsers();
                const student = users.find(u => u.username === username);

                if (!student) {
                    alert('í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + username);
                    return;
                }

                editingStudentId = student.id;

                document.getElementById('studentName').value = student.name;
                document.getElementById('studentUsername').value = student.username;
                document.getElementById('studentPassword').value = student.password || '';
                document.getElementById('studentGrade').value = student.grade;

                // Allow ID modification
                document.getElementById('studentUsername').readOnly = false;

                document.getElementById('addStudentModal').classList.add('active');
                document.querySelector('#addStudentModal .modal-title').textContent = 'í•™ìƒ ì •ë³´ ìˆ˜ì •';
                document.querySelector('#addStudentForm button[type="submit"]').textContent = 'ìˆ˜ì • ì €ì¥';
            } catch (e) {
                console.error('Error showing edit modal:', e);
                alert('ìˆ˜ì • ì°½ì„ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // Close add student modal
        function closeAddStudentModal() {
            document.getElementById('addStudentModal').classList.remove('active');
            document.getElementById('addStudentForm').reset();
            editingStudentId = null;
        }

        // Add/Edit student form submit
        document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('studentName').value;
            const username = document.getElementById('studentUsername').value;
            const password = document.getElementById('studentPassword').value;
            const grade = document.getElementById('studentGrade').value;

            try {
                if (editingStudentId) {
                    // Update
                    const updates = {
                        id: editingStudentId,
                        name, username, password, grade: parseInt(grade)
                    };
                    await dbService.saveUser(updates);
                    alert('í•™ìƒ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    // Create
                    await auth.createStudent({ name, username, password, grade });
                    alert('í•™ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }

                closeAddStudentModal();
                loadDashboard();

                // Refresh modal list if open
                if (document.getElementById('studentManagementModal').classList.contains('active')) {
                    renderStudentListInModal();
                }
            } catch (e) {
                console.error(e);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        function viewStudentDetail(studentId) {
            alert('í•™ìƒ ìƒì„¸ë³´ê¸° ê¸°ëŠ¥ì€ ê³§ ì¶œì‹œë©ë‹ˆë‹¤!');
        }

        // Consolidated deleteStudent is defined at the bottom of the file (override).


        // Show vocabulary manager
        function showVocabularyManager() {
            const modal = document.getElementById('vocabModal');
            const content = document.getElementById('vocabContent');

            let html = `
                <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
                    <select id="vocabFilterGrade" class="form-input" style="width: 120px;" onchange="searchVocabulary()">
                         <option value="">ì „ì²´ í•™ë…„</option>
                         <option value="1">1í•™ë…„</option>
                         <option value="2">2í•™ë…„</option>
                         <option value="3">3í•™ë…„</option>
                         <option value="4">4í•™ë…„</option>
                         <option value="5">5í•™ë…„</option>
                         <option value="6">6í•™ë…„</option>
                    </select>
                    <input 
                        type="text" 
                        id="vocabSearch" 
                        class="form-input" 
                        placeholder="ì–´íœ˜ ê²€ìƒ‰..."
                        onkeyup="searchVocabulary()"
                    >
                </div>
                <div style="max-height: 400px; overflow-y: auto;" id="vocabList">
                    <!-- Populated by searchVocabulary -->
                </div>
            `;

            html += `
                <div class="mt-3">
                    <button onclick="showAddVocabForm()" class="btn btn-primary" style="width: 100%;">
                        + ìƒˆ ì–´íœ˜ ì¶”ê°€
                    </button>
                </div>
            `;

            content.innerHTML = html;
            modal.classList.add('active');

            // Initial Render
            searchVocabulary();
        }

        // Show Add Vocabulary Form
        function showAddVocabForm() {
            const content = document.getElementById('vocabContent');

            content.innerHTML = `
                <div style="padding: 0.5rem;">
                    <button onclick="showVocabularyManager()" class="btn btn-sm btn-outline mb-3">
                        â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                    <h3 class="mb-3" id="vocabFormTitle">ìƒˆ ì–´íœ˜ ì¶”ê°€</h3>
                    <input type="hidden" id="editVocabId">
                    
                    <div style="background: #333; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                         <h4 style="margin-bottom: 0.5rem; color: var(--accent-color);">ğŸ“‚ CSV ë°ì´í„°ë¡œ í•œë²ˆì— ì…ë ¥í•˜ê¸°</h4>
                         <p style="font-size: 0.8rem; color: #ccc; margin-bottom: 0.5rem;">
                            í˜•ì‹: <strong>ë‹¨ì–´, í•œì, ëœ», í•™ë…„, ì¹´í…Œê³ ë¦¬, ì˜ˆë¬¸( | ë¡œ êµ¬ë¶„)</strong><br>
                            ì˜ˆì‹œ: <code>í•™êµ, å­¸æ ¡, ë°°ìš°ëŠ” ê³³, 1, ìƒí™œ, ì˜ˆë¬¸1|ì˜ˆë¬¸2</code>
                         </p>
                         <textarea id="csvInput" class="form-input" style="height: 60px; font-family: monospace;" placeholder="ì—¬ê¸°ì— CSV ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                         <button onclick="parseAndAddCSV()" class="btn btn-sm btn-outline" style="margin-top: 0.5rem; width: 100%; border-color: var(--accent-color); color: var(--accent-color);">
                            CSV ë°ì´í„° ì ìš© (ì—¬ëŸ¬ ì¤„ ê°€ëŠ¥)
                         </button>
                    </div>
                    
                    <hr style="border-color: #444; margin-bottom: 2rem;">
                    
                    <h4 class="mb-3">âœï¸ ê°œë³„ ì…ë ¥</h4>
                    
                    <div class="form-group">
                        <label class="form-label">ë‹¨ì–´ (í•œê¸€)</label>
                        <input type="text" id="newVocabWord" class="form-input" placeholder="ì˜ˆ: ì•½ì†">
                    </div>
                    
                     <div class="form-group">
                        <label class="form-label">í•œì (ì„ íƒ)</label>
                        <input type="text" id="newVocabHanja" class="form-input" placeholder="ì˜ˆ: ç´„æŸ">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ëœ»</label>
                        <input type="text" id="newVocabMeaning" class="form-input" placeholder="ë‹¨ì–´ì˜ ëœ»ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    
                    <div class="grid grid-2" style="gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">í•™ë…„</label>
                            <select id="newVocabGrade" class="form-input">
                                <option value="1">1í•™ë…„</option>
                                <option value="2">2í•™ë…„</option>
                                <option value="3">3í•™ë…„</option>
                                <option value="4">4í•™ë…„</option>
                                <option value="5">5í•™ë…„</option>
                                <option value="6">6í•™ë…„</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ì¹´ë°ê³ ë¦¬</label>
                            <input type="text" id="newVocabCategory" class="form-input" list="categoryList" placeholder="ì˜ˆ: ìƒí™œ">
                            <datalist id="categoryList">
                                <option value="êµ­ì–´">
                                <option value="ìˆ˜í•™">
                                <option value="ì‚¬íšŒ">
                                <option value="ê³¼í•™">
                                <option value="ë„ë•">
                                <option value="ìƒí™œ">
                            </datalist>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ì˜ˆë¬¸ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
                        <textarea id="newVocabExamples" class="form-input" style="height: 100px;" placeholder="ì˜ˆë¬¸ 1&#10;ì˜ˆë¬¸ 2&#10;ì˜ˆë¬¸ 3"></textarea>
                    </div>
                    
                    <button onclick="saveNewVocab()" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                        ì €ì¥í•˜ê¸°
                    </button>
                </div>
            `;
        }

        function parseAndAddCSV() {
            const raw = document.getElementById('csvInput').value.trim();
            if (!raw) return;

            const lines = raw.split('\n');
            let addedCount = 0;

            // If single line, ask to pre-fill
            if (lines.length === 1 && confirm("í•œ ì¤„ì˜ ë°ì´í„°ì…ë‹ˆë‹¤. ì…ë ¥ í¼ì— ì±„ìš°ì‹œê² ìŠµë‹ˆê¹Œ? (ì·¨ì†Œ ì‹œ ìë™ ì €ì¥)")) {
                const parts = lines[0].split(',').map(s => s.trim());
                if (parts.length >= 1) document.getElementById('newVocabWord').value = parts[0];
                if (parts.length >= 2) document.getElementById('newVocabHanja').value = parts[1];
                if (parts.length >= 3) document.getElementById('newVocabMeaning').value = parts[2];
                if (parts.length >= 4) document.getElementById('newVocabGrade').value = parts[3].replace(/[^0-9]/g, '');
                if (parts.length >= 5) document.getElementById('newVocabCategory').value = parts[4];
                if (parts.length >= 6) document.getElementById('newVocabExamples').value = parts[5].split('|').join('\n');
                return;
            }

            // Bulk Add
            if (!confirm(`ì´ ${lines.length}ê°œì˜ ë‹¨ì–´ë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            lines.forEach(line => {
                const parts = line.split(',').map(s => s.trim());
                if (parts.length < 3) return;

                const examples = parts[5] ? parts[5].split('|').map(e => e.trim()) : [];

                const newVocab = {
                    id: 'custom_' + Date.now() + Math.random().toString(36).substr(2, 5),
                    word: parts[0],
                    hanja: parts[1] || '',
                    meaning: parts[2],
                    grade: parseInt(parts[3]) || 1,
                    category: parts[4] || 'ê¸°íƒ€',
                    examples: examples
                };

                vocabDB.vocabulary.push(newVocab);
                addedCount++;
            });

            vocabDB.save();
            alert(`${addedCount}ê°œ ë‹¨ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            showVocabularyManager();
        }

        // Save New or Edited Vocabulary
        function saveNewVocab() {
            const id = document.getElementById('editVocabId').value;
            const word = document.getElementById('newVocabWord').value.trim();
            const hanja = document.getElementById('newVocabHanja').value.trim();
            const meaning = document.getElementById('newVocabMeaning').value.trim();
            const grade = parseInt(document.getElementById('newVocabGrade').value);
            const category = document.getElementById('newVocabCategory').value.trim();
            const examplesText = document.getElementById('newVocabExamples').value.trim();

            if (!word || !meaning || !category) {
                alert('ë‹¨ì–´, ëœ», ì¹´í…Œê³ ë¦¬ëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
                return;
            }

            const examples = examplesText ? examplesText.split('\n').map(e => e.trim()).filter(e => e) : [];

            const vocabData = {
                word: word,
                hanja: hanja || '',
                meaning: meaning,
                grade: grade,
                category: category,
                examples: examples
            };

            if (id) {
                // Update existing
                const index = vocabDB.vocabulary.findIndex(v => v.id === id);
                if (index !== -1) {
                    vocabDB.vocabulary[index] = { ...vocabDB.vocabulary[index], ...vocabData };
                    alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            } else {
                // Create new
                const newId = 'custom_' + Date.now();
                vocabDB.vocabulary.push({ id: newId, ...vocabData });
                alert(`'${word}' ë‹¨ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }

            vocabDB.save();
            showVocabularyManager();
        }

        function editVocab(id) {
            const vocab = vocabDB.vocabulary.find(v => v.id === id);
            if (!vocab) return;

            showAddVocabForm();

            // Populate Form
            document.getElementById('vocabFormTitle').textContent = "ì–´íœ˜ ìˆ˜ì •";
            document.getElementById('editVocabId').value = vocab.id;
            document.getElementById('newVocabWord').value = vocab.word;
            document.getElementById('newVocabHanja').value = vocab.hanja || '';
            document.getElementById('newVocabMeaning').value = vocab.meaning;
            document.getElementById('newVocabGrade').value = vocab.grade;
            document.getElementById('newVocabCategory').value = vocab.category;
            if (vocab.examples && vocab.examples.length > 0) {
                document.getElementById('newVocabExamples').value = vocab.examples.join('\n');
            }
        }

        function deleteVocab(id) {
            if (!confirm("ì •ë§ ì´ ë‹¨ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) return;

            vocabDB.vocabulary = vocabDB.vocabulary.filter(v => v.id !== id);
            vocabDB.save();
            searchVocabulary(); // Refresh list
        }

        // Close vocab modal
        function closeVocabModal() {
            document.getElementById('vocabModal').classList.remove('active');
        }

        // Search vocabulary with Grade Filter
        function searchVocabulary() {
            const searchTerm = document.getElementById('vocabSearch').value.toLowerCase();
            const gradeFilter = document.getElementById('vocabFilterGrade').value;

            const results = vocabDB.vocabulary.filter(vocab => {
                // Filter by Grade
                if (gradeFilter && vocab.grade != gradeFilter) return false;

                // Filter by Search
                if (!searchTerm) return true;
                return vocab.word.includes(searchTerm) ||
                    vocab.meaning.toLowerCase().includes(searchTerm) ||
                    (vocab.hanja && vocab.hanja.includes(searchTerm));
            });

            const listDiv = document.getElementById('vocabList');
            let html = '';

            results.forEach(vocab => {
                html += `
                    <div class="card mb-3" style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4>${vocab.word} (${vocab.hanja || ''})</h4>
                            <p class="card-text">${vocab.meaning}</p>
                            <div class="mt-2">
                                <span class="badge badge-primary">${vocab.grade}í•™ë…„</span>
                                <span class="badge badge-success">${vocab.category}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-outline" onclick="editVocab('${vocab.id}')">ìˆ˜ì •</button>
                            <button class="btn btn-sm btn-outline" style="color: #e00; border-color: #e00;" onclick="deleteVocab('${vocab.id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            });

            if (results.length === 0) {
                html = '<p class="card-text text-center" style="padding: 2rem; color: #888;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            listDiv.innerHTML = html;
        }

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
            }
        });

        // Initialize
        loadDashboard();

        // Worksheet Modal Functions
        function showWorksheetModal() {
            document.getElementById('worksheetModal').classList.add('active');
            updateWorksheetVocabList();
        }

        function closeWorksheetModal() {
            document.getElementById('worksheetModal').classList.remove('active');
        }

        function updateWorksheetVocabList() {
            const grade = document.getElementById('worksheetGrade').value;
            const searchInput = document.getElementById('worksheetSearch');
            const search = searchInput ? searchInput.value.toLowerCase() : '';
            const listContainer = document.getElementById('worksheetVocabList');

            if (!listContainer) return;

            let filtered = vocabDB.vocabulary;
            if (grade) {
                filtered = filtered.filter(v => v.grade == grade);
            }
            if (search) {
                filtered = filtered.filter(v =>
                    v.word.includes(search) ||
                    v.meaning.toLowerCase().includes(search)
                );
            }

            // Keep checked state
            const currentlyChecked = Array.from(listContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);

            let html = '';
            if (filtered.length === 0) {
                html = '<div style="padding: 1rem; text-align: center; color: #666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                filtered.forEach(v => {
                    const isChecked = currentlyChecked.includes(v.id) ? 'checked' : '';
                    html += `
                        <label class="vocab-checkbox-item">
                            <input type="checkbox" name="worksheetVocab" value="${v.id}" ${isChecked} onchange="updateSelectedCount()">
                            <span class="vocab-text">${v.word}</span>
                        </label>
                    `;
                });
            }
            listContainer.innerHTML = html;
            updateSelectedCount();
        }

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('#worksheetVocabList input[type="checkbox"]');
            if (checkboxes.length === 0) return;

            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = document.querySelectorAll('input[name="worksheetVocab"]:checked').length;
            const counter = document.getElementById('selectedCount');
            if (counter) counter.textContent = count > 0 ? `${count}ê°œ ì„ íƒë¨` : 'ëœë¤ ìƒì„±';
        }

        function generateWorksheet(arg = null) {
            let vocabList = [];
            let title = '';
            let type = '';
            let restoreData = null;

            // Check if arg is restore data (object) or type (string)
            const isRestore = arg && typeof arg === 'object';
            const isNewType = arg && typeof arg === 'string';

            if (isRestore) {
                // Restore mode
                restoreData = arg;
                const vocabIds = restoreData.vocabIds;
                vocabList = vocabDB.vocabulary.filter(v => vocabIds.includes(v.id));
                title = restoreData.title;
                type = restoreData.type;
            } else if (isNewType) {
                // New generation mode from Buttons
                type = arg;

                const checkboxes = document.querySelectorAll('.vocab-checkbox-item input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                    alert('ì„ íƒëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                const selectedIds = Array.from(checkboxes).map(cb => cb.value);
                // Preserve order based on vocabDB
                vocabList = vocabDB.vocabulary.filter(v => selectedIds.includes(v.id));

                if (type === 'meaning') {
                    title = 'ì–´íœ˜ ëœ» ë”°ë¼ì“°ê¸°';
                } else if (type === 'sentence') {
                    title = 'ì–´íœ˜ ìš©ë¡€ ë”°ë¼ì“°ê¸°';
                } else if (type === 'hanja') {
                    title = 'í•œì ì“°ê¸° ì—°ìŠµ';
                } else if (type === 'quiz') {
                    title = 'ì–´íœ˜ ìª½ì§€ ì‹œí—˜';
                }
            } else {
                return; // Should not happen
            }

            // Use the Shared Renderer
            const result = WorksheetRenderer.generate(type, vocabList);
            const content = result.content;
            const writerScript = result.writerScript;

            // Save to LocalStorage (if new)
            if (!isRestore) {
                const worksheetData = {
                    id: Date.now(),
                    title: title,
                    type: type,
                    vocabIds: vocabList.map(v => v.id),
                    createdAt: new Date().toISOString(),
                    dateStr: new Date().toLocaleString('ko-KR')
                };
                const savedWorksheets = JSON.parse(localStorage.getItem('savedWorksheets') || '[]');
                savedWorksheets.unshift(worksheetData);
                localStorage.setItem('savedWorksheets', JSON.stringify(savedWorksheets));
            }

            printWorksheet(title, content, writerScript);
        }

        function printWorksheet(title, content, extraScript = '') {
            const fullHtml = `
                <!DOCTYPE html>
                <html>
                <script>
                    window.onafterprint = function() {
                        // Ensure window stays open and content remains
                        console.log("Print dialog closed.");
                    };
                <\/script>

    <head>
        <title>${title} - ì–´íœ˜ë‚˜ë¼ ì›Œí¬ì‹œíŠ¸</title>
        <link href="https://fonts.googleapis.com/css2?family=Gamja+Flower&family=Nanum+Gothic:wght@400;700&display=swap"
            rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"><\/script>
                    <style>
                        body { font-family: 'Gamja Flower', cursive, sans-serif; padding: 20px; }
                        h1 { margin: 0; font-size: 2rem; }
                        .worksheet-section { margin-top: 10px; }
                        .vocab-section-break { page-break-before: always; height: 1px; }
                        .vocab-section-break:first-child { page-break-before: auto; }

                        .vocab-header { font-size: 24px; margin-bottom: 10px; }
                        .vocab-header.centered { text-align: center; margin-bottom: 30px; }
                        .vocab-word { font-weight: bold; font-size: 28px; color: #333; }
                        .vocab-hanja { color: #666; font-size: 24px; }
                        .vocab-meaning-box { background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px; font-size: 18px; }

                        .sentences-list { display: flex; flex-direction: column; gap: 20px; }
                        .sentence-item { break-inside: avoid; margin-bottom: 15px; }
                        .sentence-text { font-size: 18px; margin-bottom: 10px; }
                        .writing-line { border-bottom: 1px dashed #bbb; height: 30px; }

                        .hanja-table { width: 100%; border-collapse: collapse; }
                        .hanja-table th, .hanja-table td { border: 1px solid #ddd; padding: 15px; text-align: center; }
                        .hanja-table th { background: #f5f5f5; }
                        .vocab-hanja-large { font-size: 32px; font-weight: bold; }
                        .hanja-writing-box { display: flex; gap: 10px; justify-content: center; }
                        .writing-box { width: 40px; height: 40px; border: 1px solid #ccc; }

                        /* Stroke Order Sequence Styles */
                        .stroke-order-container {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 4px;
                            margin: 10px 0 10px 0;
                            border-top: 1px dashed #eee;
                            padding-top: 10px;
                        }
                        .stroke-order-step {
                            width: 40px;
                            height: 40px;
                            border: 1px solid #eee;
                            background: #fff;
                        }

                        /* 15-cell Grid Styles */
                        .vocab-15-section { margin-bottom: 15px; break-inside: avoid; }
                        .vocab-info-header { display: flex; gap: 10px; margin-bottom: 5px; align-items: baseline; }
                        .word-box { font-size: 24px; font-weight: bold; border: 2px solid #333; padding: 5px 15px; border-radius: 20px; background: #fffde7; }
                        .hanja-box { font-size: 20px; color: #555; }

                        .penmanship-grid-container {
                            display: grid; grid-template-columns: repeat(15, 1fr);
                            width: 100%; max-width: 100%;
                            border-right: 1px solid #888;
                            border-bottom: 1px solid #888;
                            background: #fff;
                        }
                        .grid-row { display: contents; }
                        .grid-cell {
                            aspect-ratio: 1;
                            border-left: 1px solid #888;
                            border-top: 1px solid #888;
                            display: flex; align-items: center; justify-content: center;
                            font-size: 2.4rem; position: relative;
                            color: #d0d0d0; /* Light Gray text */
                        }

                        /* Cross Dotted Line Guidelines in Cell */
                        .grid-cell::before {
                            content: ''; position: absolute; top: 50%; left: 0; right: 0;
                            border-top: 1px dotted #ccc; z-index: 0;
                        }
                        .grid-cell::after {
                            content: ''; position: absolute; left: 50%; top: 0; bottom: 0;
                            border-left: 1px dotted #ccc; z-index: 0;
                        }

                        /* Text Layer */
                        .grid-cell-text { z-index: 1; position: relative; font-family: 'Nanum Gothic', sans-serif; font-weight: 700; }

                        /* Sentence Grid Modifier (90% Scale) */
                        .sentence-grid .grid-cell { font-size: 2.1rem; }

                        /* Hanja Grid Modifier (Max Size) */
                        .hanja-grid .grid-cell { font-size: 3.8rem; line-height: 1; }

                        /* Print Button Style */
                        .print-btn-container {
                            position: fixed; top: 20px; right: 20px; z-index: 1000;
                        }
                        .print-btn {
                            background-color: #333; color: white; border: none; padding: 10px 20px;
                            border-radius: 5px; cursor: pointer; font-size: 16px;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                            display: flex; align-items: center; gap: 8px;
                            transition: background-color 0.2s;
                            font-family: sans-serif;
                        }
                        .print-btn:hover { background-color: #555; }

                        @media print {
                            .no-print { display: none !important; }
                            body { padding: 0; }
                            .penmanship-grid-container { border-color: #000; }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-btn-container no-print">
                        <button class="print-btn" onclick="window.print()">
                            <span>ğŸ–¨ï¸</span> ì¸ì‡„í•˜ê¸°
                        </button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px;">
                        <h1>${title}</h1>
                        <span style="font-size: 0.9rem; color: #555;">ìƒì„±: ${new Date().toLocaleString('ko-KR')}</span>
                    </div>
                    <div style="text-align: right; margin-bottom: 20px;">
                        <span>í•™ë…„: _____ ë°˜: _____ ì´ë¦„: __________</span>
                    </div>
                    ${content}

                    <script>
                        // Extra Script for dynamic content (e.g. HanziWriter)
                        try {
                            ${extraScript}
                        } catch(e) { console.error(e); }
                    <\/script>
                </body>
                </html>
            `;
            const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        }
    </script>

    <!-- Worksheet Generation Modal -->
    <div class="modal-overlay" id="worksheetModal">
        <div class="modal" style="position: relative; max-width: 900px;">
            <button class="modal-close" onclick="closeWorksheetModal()">Ã—</button>
            <div class="modal-header">
                <h2 class="modal-title">í•™ìŠµì§€ ìƒì„±</h2>
                <p style="color: #666;">í•™ë…„ì„ ì„ íƒí•˜ê³  ì›í•˜ëŠ” ë‹¨ì–´ë¥¼ ì²´í¬í•œ ë’¤ ë©”ë‰´ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>
            </div>

            <div style="display: grid; grid-template-columns: 350px 1fr; gap: 2rem;">
                <!-- Left: Options & List -->
                <div style="border-right: 1px solid #eee; padding-right: 1rem;">
                    <div style="margin-bottom: 1rem;">
                        <label class="form-label">ëŒ€ìƒ í•™ë…„</label>
                        <select id="worksheetGrade" class="form-input" onchange="updateWorksheetVocabList()">
                            <option value="">ì „ì²´ í•™ë…„</option>
                            <option value="1">1í•™ë…„</option>
                            <option value="2">2í•™ë…„</option>
                            <option value="3">3í•™ë…„</option>
                            <option value="4">4í•™ë…„</option>
                            <option value="5">5í•™ë…„</option>
                            <option value="6">6í•™ë…„</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" id="worksheetSearch" class="form-input" placeholder="ë‹¨ì–´ ê²€ìƒ‰..."
                                onkeyup="updateWorksheetVocabList()">
                            <button class="btn btn-sm btn-outline" onclick="toggleSelectAll()">ì „ì²´</button>
                        </div>
                        <div class="vocab-selection-list" id="worksheetVocabList">
                            <!-- Populated by JS -->
                        </div>
                        <div style="text-align: right; font-size: 0.9rem; color: var(--primary-500); margin-top: 0.5rem;"
                            id="selectedCount">
                            ëœë¤ ìƒì„±
                        </div>
                    </div>
                </div>

                <!-- Right: Action Buttons -->
                <div class="grid grid-1" style="gap: 1rem; align-content: start;">
                    <button onclick="generateWorksheet('meaning')" class="card text-center btn-outline"
                        style="padding: 1.5rem; border: 2px solid var(--primary-200); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 2rem;">âœï¸</div>
                        <div style="text-align: left;">
                            <h3>ë‹¨ì–´ ëœ» ë”°ë¼ì“°ê¸°</h3>
                            <p style="font-size: 0.9rem; color: #666;">ì„ íƒí•œ ë‹¨ì–´ì˜ ëœ»ì„ 15ì¹¸ íœê¸€ì”¨ í˜•ì‹ìœ¼ë¡œ ì—°ìŠµí•©ë‹ˆë‹¤.</p>
                        </div>
                    </button>

                    <button onclick="generateWorksheet('sentence')" class="card text-center btn-outline"
                        style="padding: 1.5rem; border: 2px solid var(--secondary-200); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 2rem;">ğŸ“</div>
                        <div style="text-align: left;">
                            <h3>ìš©ë¡€ ë”°ë¼ì“°ê¸°</h3>
                            <p style="font-size: 0.9rem; color: #666;">ì„ íƒí•œ ë‹¨ì–´ì˜ 10ê°œ ì˜ˆë¬¸ì„ ë”°ë¼ ì”ë‹ˆë‹¤.</p>
                        </div>
                    </button>

                    <button onclick="generateWorksheet('hanja')" class="card text-center btn-outline"
                        style="padding: 1.5rem; border: 2px solid var(--accent-200); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 2rem;">ğŸˆ³</div>
                        <div style="text-align: left;">
                            <h3>í•œì ë”°ë¼ì“°ê¸°</h3>
                            <p style="font-size: 0.9rem; color: #666;">í•œì ì“°ê¸° ì—°ìŠµì¥ì„ ë§Œë“­ë‹ˆë‹¤.</p>
                        </div>
                    </button>

                    <button onclick="generateWorksheet('quiz')" class="card text-center btn-outline"
                        style="padding: 1.5rem; border: 2px solid #ff9f43; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 2rem;">â“</div>
                        <div style="text-align: left;">
                            <h3>ìª½ì§€ ì‹œí—˜ ìƒì„±</h3>
                            <p style="font-size: 0.9rem; color: #666;">ë¹ˆì¹¸ ì±„ìš°ê¸° í…ŒìŠ¤íŠ¸ì§€ë¥¼ ë§Œë“­ë‹ˆë‹¤.</p>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <style>
            .vocab-selection-list {
                height: 300px;
                overflow-y: auto;
                border: 1px solid #333;
                border-radius: 8px;
                padding: 0.5rem;
                background: #000;
                color: #fff;
            }

            .vocab-checkbox-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.8rem;
                border-bottom: 1px solid #222;
                cursor: pointer;
                transition: background 0.2s;
            }

            .vocab-checkbox-item:hover {
                background: #111;
            }

            .vocab-text {
                font-size: 1.1rem;
                font-weight: 500;
            }

            .vocab-checkbox-item input[type="checkbox"] {
                width: 16px;
                height: 16px;
            }
        </style>
    </div>
    <!-- Quiz Generation Modal -->
    <div class="modal-overlay" id="quizModal">
        <div class="modal" style="position: relative; max-width: 900px;">
            <button class="modal-close" onclick="closeQuizModal()">Ã—</button>
            <div class="modal-header">
                <h2 class="modal-title">í€´ì¦ˆ ìƒì„± ë° ë°°í¬</h2>
                <p style="color: #666;">í•™ìƒë“¤ì—ê²Œ ë°°í¬í•  í€´ì¦ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
            </div>

            <div style="display: grid; grid-template-columns: 350px 1fr; gap: 2rem;">
                <!-- Word Selection -->
                <div style="border-right: 1px solid #eee; padding-right: 1rem;">
                    <div style="margin-bottom: 1rem;">
                        <label class="form-label">ëŒ€ìƒ í•™ë…„</label>
                        <select id="quizGrade" class="form-input" onchange="updateQuizVocabList()">
                            <option value="">ì „ì²´ í•™ë…„</option>
                            <option value="1">1í•™ë…„</option>
                            <option value="2">2í•™ë…„</option>
                            <option value="3">3í•™ë…„</option>
                            <option value="4">4í•™ë…„</option>
                            <option value="5">5í•™ë…„</option>
                            <option value="6">6í•™ë…„</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" id="quizSearch" class="form-input" placeholder="ë‹¨ì–´ ê²€ìƒ‰..."
                                onkeyup="updateQuizVocabList()">
                            <button class="btn btn-sm btn-outline" onclick="toggleQuizSelectAll()">ì „ì²´</button>
                        </div>
                        <div class="vocab-selection-list" id="quizVocabList">
                            <!-- Populated by JS -->
                        </div>
                        <div style="text-align: right; font-size: 0.9rem; color: var(--primary-500); margin-top: 0.5rem;"
                            id="quizSelectedCount">
                            0ê°œ ì„ íƒë¨
                        </div>
                    </div>
                </div>

                <!-- Quiz Options -->
                <div>
                    <div class="form-group">
                        <label class="form-label">í€´ì¦ˆ ì œëª©</label>
                        <input type="text" id="quizTitle" class="form-input" placeholder="ì˜ˆ: 1ë‹¨ì› ë‹¨ì–´ ìª½ì§€ì‹œí—˜">
                    </div>
                    <div class="form-group">
                        <label class="form-label">í€´ì¦ˆ ìœ í˜•</label>
                        <select id="quizType" class="form-input">
                            <option value="meaning_match">ë‹¨ì–´ ëœ» ë§ì¶”ê¸° (ê°ê´€ì‹)</option>
                        </select>
                    </div>

                    <button onclick="createQuiz()" class="btn btn-primary"
                        style="width: 100%; padding: 1rem; margin-top: 1rem;">
                        ğŸš€ í€´ì¦ˆ ìƒì„± ë° ë°°í¬í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showQuizModal() {
            document.getElementById('quizModal').classList.add('active');
            updateQuizVocabList();
        }

        function closeQuizModal() {
            document.getElementById('quizModal').classList.remove('active');
        }

        function updateQuizVocabList() {
            const listDiv = document.getElementById('quizVocabList');
            const gradeFilter = document.getElementById('quizGrade').value;
            const search = document.getElementById('quizSearch').value.toLowerCase();

            let filtered = vocabDB.vocabulary.filter(v => {
                if (gradeFilter && v.grade != gradeFilter) return false;
                if (search && !v.word.includes(search) && !v.meaning.toLowerCase().includes(search)) return false;
                return true;
            });

            // If empty search/grade, limit to 100 for perf? Or show all (1000 items might lag rendering).
            // Worksheet logic renders all? No, it handles it. 
            // 1000 checkboxes is heavy but manageable.

            let html = '';
            filtered.forEach(v => {
                html += `
                    <label class="vocab-checkbox-item">
                        <input type="checkbox" name="quizVocab" value="${v.id}" onchange="updateQuizSelectedCount()">
                        <span class="vocab-text">${v.word}</span>
                    </label>
                `;
            });

            if (filtered.length === 0) {
                html = '<div style="padding:1rem; text-align:center; color:#888;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }

            listDiv.innerHTML = html;
            updateQuizSelectedCount();
        }

        function updateQuizSelectedCount() {
            const count = document.querySelectorAll('input[name="quizVocab"]:checked').length;
            document.getElementById('quizSelectedCount').textContent = count + 'ê°œ ì„ íƒë¨';
        }

        function toggleQuizSelectAll() {
            const checkboxes = document.querySelectorAll('input[name="quizVocab"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            updateQuizSelectedCount();
        }

        function createQuiz() {
            const checkboxes = document.querySelectorAll('input[name="quizVocab"]:checked');
            if (checkboxes.length === 0) {
                alert('í€´ì¦ˆì— í¬í•¨í•  ë‹¨ì–´ë¥¼ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            if (checkboxes.length < 4) {
                alert('ê°ê´€ì‹ ë¬¸í•­ ìƒì„±ì„ ìœ„í•´ ìµœì†Œ 4ê°œ ì´ìƒì˜ ë‹¨ì–´ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤. (ì˜¤ë‹µ ë³´ê¸° ìƒì„±ìš©)');
                // Actually we can pull distractors from global DB even if not selected for quiz.
                // But selected words are the TARGETS.
            }

            const title = document.getElementById('quizTitle').value.trim();
            if (!title) {
                alert('í€´ì¦ˆ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            const targets = vocabDB.vocabulary.filter(v => selectedIds.includes(v.id));

            // Generate Questions
            const questions = targets.map(v => {
                // Pick 3 distractors from ALL vocabulary (excluding correct one)
                // To ensure quality distractors, maybe same grade?
                let pool = vocabDB.vocabulary.filter(d => d.id !== v.id);
                if (v.grade) {
                    const gradePool = pool.filter(d => d.grade == v.grade);
                    if (gradePool.length >= 3) pool = gradePool;
                }

                const distractors = pool.sort(() => 0.5 - Math.random()).slice(0, 3).map(d => d.meaning);
                const options = [...distractors, v.meaning].sort(() => 0.5 - Math.random());

                return {
                    id: 'q_' + Date.now() + Math.random().toString(36).substr(2, 9),
                    type: 'meaning_match',
                    questionText: `'${v.word}'ì˜ ëœ»ì€ ë¬´ì—‡ì¸ê°€ìš”?`,
                    correctAnswer: v.meaning,
                    options: options,
                    wordId: v.id
                };
            });

            const quiz = {
                id: 'quiz_' + Date.now(),
                title: title,
                questions: questions,
                createdAt: new Date().toISOString(),
                targetGrade: document.getElementById('quizGrade').value || 'Mixed',
                active: true,
                stats: { attempts: 0, avgScore: 0 }
            };

            // Save to LocalStorage
            const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            quizzes.push(quiz);
            localStorage.setItem('quizzes', JSON.stringify(quizzes));

            alert(`âœ… í€´ì¦ˆ '${title}'ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„± ë° ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n(í•™ìƒë“¤ì´ 'ì˜¤ëŠ˜ì˜ í•™ìŠµ' ë˜ëŠ” 'í€´ì¦ˆ' ë©”ë‰´ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)`);
            closeQuizModal();
        }
    </script>

    <!-- Saved Worksheets Modal -->
    <div class="modal-overlay" id="savedWorksheetsModal">
        <div class="modal" style="position: relative; max-width: 800px;">
            <button class="modal-close" onclick="closeSavedWorksheetsModal()">Ã—</button>
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“‚ ì €ì¥ëœ í•™ìŠµì§€ ëª©ë¡</h2>
            </div>
            <div id="savedWorksheetsList" style="max-height: 500px; overflow-y: auto;">
                <!-- List Items -->
            </div>
        </div>
    </div>

    <script>
        function showSavedWorksheetsModal() {
            document.getElementById('savedWorksheetsModal').classList.add('active');
            renderSavedWorksheets();
        }

        function closeSavedWorksheetsModal() {
            document.getElementById('savedWorksheetsModal').classList.remove('active');
        }

        function renderSavedWorksheets() {
            const listDiv = document.getElementById('savedWorksheetsList');
            const saved = JSON.parse(localStorage.getItem('savedWorksheets') || '[]');

            if (saved.length === 0) {
                listDiv.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">ì €ì¥ëœ í•™ìŠµì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let html = '<div class="sentences-list">';
            saved.forEach((item, index) => {
                let typeLabel = 'ê¸°íƒ€';
                if (item.type === 'meaning') typeLabel = 'ë‹¨ì–´ ëœ»';
                else if (item.type === 'sentence') typeLabel = 'ìš©ë¡€';
                else if (item.type === 'hanja') typeLabel = 'í•œì';
                else if (item.type === 'quiz') typeLabel = 'ìª½ì§€ì‹œí—˜';
                html += `
                    <div class="card" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 10px;">
                        <div>
                            <div style="font-weight: bold; font-size: 1.1rem;">${item.title}</div>
                            <div style="color: #666; font-size: 0.8rem;">
                                ${item.dateStr} | ìœ í˜•: ${typeLabel} | ë‹¨ì–´ ${item.vocabIds.length}ê°œ
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary btn-sm" onclick="distributeWorksheet(${index})">ğŸ“¢ ë°°í¬</button>
                            <button class="btn btn-outline btn-sm" onclick="restoreWorksheet(${index})">ğŸ–¨ï¸ ë³´ê¸°</button>
                            <button class="btn btn-outline btn-sm" style="color: #e00; border-color: #e00;" onclick="deleteSavedWorksheet(${index})">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            listDiv.innerHTML = html;
        }

        function distributeWorksheet(index) {
            const saved = JSON.parse(localStorage.getItem('savedWorksheets') || '[]');
            const item = saved[index];
            if (!item) return;

            if (!confirm(`'${item.title}' í•™ìŠµì§€ë¥¼ ì „ì²´ í•™ìƒì—ê²Œ ë°°í¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const assignment = {
                id: 'assign_' + Date.now(),
                worksheetId: item.id,
                originalData: item,
                title: item.title,
                createdAt: new Date().toISOString(),
                dateStr: new Date().toLocaleString('ko-KR'),
                target: 'all'
            };

            const assignments = JSON.parse(localStorage.getItem('assignments') || '[]');
            assignments.unshift(assignment);
            localStorage.setItem('assignments', JSON.stringify(assignments));

            alert('âœ… í•™ìŠµì§€ê°€ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.\ní•™ìƒë“¤ì´ ë¡œê·¸ì¸í•˜ì—¬ í•´ë‹¹ í•™ìŠµì§€ë¥¼ ì‘ì„±í•˜ê³  ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }

        function restoreWorksheet(index) {
            const saved = JSON.parse(localStorage.getItem('savedWorksheets') || '[]');
            const item = saved[index];
            if (!item) return;
            generateWorksheet(item.type, item);
        }

        function deleteSavedWorksheet(index) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const saved = JSON.parse(localStorage.getItem('savedWorksheets') || '[]');
            saved.splice(index, 1);
            localStorage.setItem('savedWorksheets', JSON.stringify(saved));
            renderSavedWorksheets();
        }
    </script>

    <script src="../js/worksheet-renderer.js"></script>

    <!-- Distributed Worksheets List Modal -->
    <div class="modal-overlay" id="distributedModal">
        <div class="modal" style="position: relative; max-width: 800px;">
            <button class="modal-close"
                onclick="document.getElementById('distributedModal').classList.remove('active')">Ã—</button>
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“¨ ë°°í¬ëœ í•™ìŠµì§€ ê´€ë¦¬</h2>
            </div>
            <div id="distributedList" style="max-height: 500px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Submission List Modal -->
    <div class="modal-overlay" id="submissionListModal" style="z-index: 1050;">
        <div class="modal" style="position: relative; max-width: 600px;">
            <button class="modal-close"
                onclick="document.getElementById('submissionListModal').classList.remove('active')">Ã—</button>
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“ ì œì¶œ í˜„í™©</h2>
                <p id="submissionListTitle" style="color: #666;"></p>
            </div>
            <div id="submissionListHelper"></div>
        </div>
    </div>

    <!-- Submission Detail Modal -->
    <div class="modal-overlay" id="submissionDetailModal" style="z-index: 1100;">
        <div class="modal" style="position: relative; max-width: 90%; width: 900px; height: 90vh; padding: 0;">
            <button class="modal-close"
                onclick="document.getElementById('submissionDetailModal').classList.remove('active')"
                style="z-index: 10; background: #fff; border-radius: 50%; width: 30px; height: 30px;">Ã—</button>
            <div style="height: 100%; overflow: auto; padding: 20px; position: relative; background: #555;">
                <div id="reviewContainer"
                    style="background: #fff; width: 794px; min-height: 1123px; padding: 40px; margin: 0 auto; position: relative;">
                    <div id="reviewContent"></div>
                    <img id="reviewInk"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Triggered by "Distributed Worksheets" Card
        function showDistributedWorksheets() {
            document.getElementById('distributedModal').classList.add('active');
            renderDistributedList();
        }

        function renderDistributedList() {
            const listDiv = document.getElementById('distributedList');
            const assignments = JSON.parse(localStorage.getItem('assignments') || '[]');
            const submissions = JSON.parse(localStorage.getItem('submissions') || '[]');

            if (assignments.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #888;">ë°°í¬ëœ í•™ìŠµì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            listDiv.innerHTML = assignments.map(a => {
                const subCount = submissions.filter(s => s.assignmentId === a.id).length;
                return `
                    <div class="card" style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; padding: 10px;">
                        <div>
                            <h3 style="margin:0; font-size: 1.1rem;">${a.title}</h3>
                            <p style="color: #666; margin:0; font-size: 0.8rem;">ë°°í¬ì¼: ${a.dateStr}</p>
                        </div>
                        <div style="text-align: right; display: flex; align-items: center; gap: 10px;">
                            <div style="font-weight: bold; font-size: 0.9rem;">ì œì¶œ: ${subCount}ëª…</div>
                            <button class="btn btn-primary btn-sm" onclick="showSubmissions('${a.id}')">í™•ì¸</button>
                            <button class="btn btn-outline btn-sm" style="color: #e00; border-color: #e00;" onclick="deleteDistributedWorksheet('${a.id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteDistributedWorksheet(assignId) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì œì¶œëœ ê³¼ì œ ë°ì´í„°ëŠ” ìœ ì§€ë˜ì§€ë§Œ ëª©ë¡ì—ì„œ ì‚¬ë¼ì§‘ë‹ˆë‹¤)')) return;

            let assignments = JSON.parse(localStorage.getItem('assignments') || '[]');
            assignments = assignments.filter(a => a.id !== assignId);
            localStorage.setItem('assignments', JSON.stringify(assignments));

            renderDistributedList();
        }

        function showSubmissions(assignId) {
            const submissions = JSON.parse(localStorage.getItem('submissions') || '[]');
            const assignments = JSON.parse(localStorage.getItem('assignments') || '[]');
            const assignment = assignments.find(a => a.id === assignId);

            const filtered = submissions.filter(s => s.assignmentId === assignId);

            document.getElementById('submissionListTitle').textContent = assignment ? assignment.title : '';
            const listHelper = document.getElementById('submissionListHelper');

            document.getElementById('submissionListModal').classList.add('active');

            if (filtered.length === 0) {
                listHelper.innerHTML = '<p style="text-align: center; padding: 20px;">ì œì¶œëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            listHelper.innerHTML = filtered.map(s => `
                <div class="card" style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; padding: 15px;">
                    <div>
                        <strong>${s.studentName}</strong>
                        <div style="font-size: 0.8rem; color: #666;">${new Date(s.submittedAt).toLocaleString()}</div>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="openReviewSafe('${s.id}')">ì±„ì /ë³´ê¸°</button>
                </div>
            `).join('');
        }

        function openReview(subId) {
            const submissions = JSON.parse(localStorage.getItem('submissions') || '[]');
            const submission = submissions.find(s => s.id === subId);
            if (!submission) return;

            const assignments = JSON.parse(localStorage.getItem('assignments') || '[]');
            const assignment = assignments.find(a => a.id === submission.assignmentId);

            // Render Content
            const vocabIds = assignment.originalData.vocabIds;
            const type = assignment.originalData.type;
            const vocabList = vocabDB.vocabulary.filter(v => vocabIds.includes(v.id));

            const rendered = WorksheetRenderer.generate(type, vocabList);
            document.getElementById('reviewContent').innerHTML = rendered.content;

            // Render Ink
            document.getElementById('reviewInk').src = submission.inkData;

            document.getElementById('submissionDetailModal').classList.add('active');
        }
        function openReviewSafe(subId) {
            const submissions = JSON.parse(localStorage.getItem('submissions') || '[]');
            const submission = submissions.find(s => s.id === subId);
            if (!submission) return;

            const reviewContent = document.getElementById('reviewContent');
            const reviewInk = document.getElementById('reviewInk');

            reviewContent.innerHTML = '';
            reviewInk.style.display = 'none';

            if (submission.isFullImage) {
                reviewContent.innerHTML = `<img src="${submission.inkData}" style="width: 100%; box-shadow: 0 0 10px rgba(0,0,0,0.1);">`;
            } else {
                const assignments = JSON.parse(localStorage.getItem('assignments') || '[]');
                const assignment = assignments.find(a => a.id === submission.assignmentId);
                if (assignment) {
                    const vocabIds = assignment.originalData.vocabIds;
                    const type = assignment.originalData.type;
                    const vocabList = vocabDB.vocabulary.filter(v => vocabIds.includes(v.id));
                    const rendered = WorksheetRenderer.generate(type, vocabList);
                    reviewContent.innerHTML = rendered.content;
                    reviewInk.src = submission.inkData;
                    reviewInk.style.display = 'block';
                }
            }
            document.getElementById('submissionDetailModal').classList.add('active');
        }
        // --- Daily Plan Manager Logic ---
        let currentPlanWords = [];

        function showDailyPlanModal() {
            document.getElementById('dailyPlanModal').classList.add('active');
            // Default to today and grade 3
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('planDate').value = today;
            document.getElementById('planGrade').value = '3';
            loadPlanForEditor();
        }

        function closeDailyPlanModal() {
            document.getElementById('dailyPlanModal').classList.remove('active');
            currentPlanWords = [];
        }

        async function loadPlanForEditor() {
            const dateStr = document.getElementById('planDate').value;
            const grade = document.getElementById('planGrade').value;
            const listEl = document.getElementById('planWordsList');

            if (!dateStr || !grade) return;

            listEl.innerHTML = '<div style="padding:1rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            // Try fetch from DBService
            let plan = await dbService.getDailyPlan(dateStr, grade);

            if (plan && plan.words && plan.words.length > 0) {
                // Fetch vocab objects
                currentPlanWords = vocabDB.vocabulary.filter(v => plan.words.includes(v.id));
                // Sort to match order? plan.words is array of IDs.
                // Map IDs to objects to preserve order
                currentPlanWords = plan.words.map(id => vocabDB.vocabulary.find(v => v.id === id)).filter(v => v);
            } else {
                // Generate random default if not exists (simulate what student sees)
                // But wait, getDailyWords generates and saves. 
                // We can generate here for preview, but not save until User clicks Save.
                const generated = vocabDB.getDailyWords(2, parseInt(grade), dateStr);
                // Note: getDailyWords might save to LS if not found.
                currentPlanWords = generated;
            }

            renderPlanWords();
        }

        function renderPlanWords() {
            const listEl = document.getElementById('planWordsList');
            listEl.innerHTML = '';

            if (currentPlanWords.length === 0) {
                listEl.innerHTML = '<div style="color:#aaa;">ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            currentPlanWords.forEach((vocab, index) => {
                const div = document.createElement('div');
                div.className = 'glass-card';
                div.style.padding = '1rem';
                div.style.marginBottom = '0.5rem';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';

                div.innerHTML = `
                    <div>
                        <strong style="color: var(--primary-color); font-size: 1.2rem;">${vocab.word}</strong>
                        <span style="color: #aaa; margin-left:10px;">${vocab.meaning}</span>
                        <div style="font-size: 0.9rem; color: #888;">${vocab.hanja || ''}</div>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline" onclick="changeWordInPlan(${index})">ë³€ê²½</button>
                    </div>
                `;
                listEl.appendChild(div);
            });
        }

        function changeWordInPlan(index) {
            const newWord = prompt("ê²€ìƒ‰í•  ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (í•œê¸€/í•œì/ëœ»):");
            if (!newWord) return;

            const results = vocabDB.search(newWord);
            if (results.length === 0) {
                alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // Simple selection logic for now: pick first or show list
            // For MVP, if multiple, ask user to be specific or take first.
            // Or render list in prompt? No.
            // Let's just pick first and confirm.
            const candidate = results[0];
            if (confirm(`'${candidate.word}' (${candidate.meaning}) ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                currentPlanWords[index] = candidate;
                renderPlanWords();
            }
        }

        async function openWordSearchForPlan() {
            // For adding a new word (if we want more than 2?) or just changing both?
            // Prompt user: "How many words?" or just Add one.
            // Let's keep it fixed to 2 as per system requirement, OR allow adding?
            // Request was "modify". So existing 2 -> different 2.
            // But button says "+ ë‹¨ì–´ ë³€ê²½/ê²€ìƒ‰".
            // Let's assume user wants to ADD or Replace.
            alert("ë‹¨ì–´ ë³€ê²½ ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì—¬ ê°œë³„ ë‹¨ì–´ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.");
        }

        async function savePlanFromEditor() {
            const dateStr = document.getElementById('planDate').value;
            const grade = document.getElementById('planGrade').value;

            if (!currentPlanWords || currentPlanWords.length === 0) {
                alert("ì €ì¥í•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const wordIds = currentPlanWords.map(v => v.id);
            await dbService.saveDailyPlan(dateStr, grade, wordIds);
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeDailyPlanModal();
        }
    </script>
    <!-- Student Management Modal -->
    <div class="modal-overlay" id="studentManagementModal">
        <div class="modal" style="position: relative; max-width: 800px;">
            <button class="modal-close"
                onclick="document.getElementById('studentManagementModal').classList.remove('active')">Ã—</button>
            <!-- CSV Bulk Upload Section -->
            <div id="studentCsvSection"
                style="margin-bottom: 1.5rem; background: #f8f9fa; padding: 1rem; border-radius: 8px; display: none;">
                <h4>ğŸ“‚ í•™ìƒ ì¼ê´„ ë“±ë¡ (CSV)</h4>
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                    í˜•ì‹: <strong>ì´ë¦„, ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸, í•™ë…„</strong> (ì½¤ë§ˆë¡œ êµ¬ë¶„, ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ëª…)
                    <br>ì˜ˆì‹œ: <code>ê¹€ì² ìˆ˜, kcs01, 1234, 3</code>
                </p>
                <textarea id="studentCsvInput" class="form-input" style="height: 100px; font-family: monospace;"
                    placeholder="ì—¬ê¸°ì— CSV ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button onclick="processStudentCsv()" class="btn btn-success" style="flex: 1;">ì¼ê´„ ë“±ë¡í•˜ê¸°</button>
                    <button onclick="toggleStudentCsv()" class="btn btn-outline">ì·¨ì†Œ</button>
                </div>
            </div>

            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2 class="modal-title">ğŸ‘¥ í•™ìƒ ê´€ë¦¬</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="toggleStudentCsv()" class="btn btn-outline"
                        style="border-color: #2ecc71; color: #2ecc71;">
                        ğŸ“‚ CSV ì¼ê´„ ì¶”ê°€
                    </button>
                    <button onclick="showAddStudentModal()" class="btn btn-primary">
                        + í•™ìƒ ì¶”ê°€
                    </button>
                </div>
            </div>

            <!-- Student List Container -->
            <div id="studentsListModalContainer" style="max-height: 500px; overflow-y: auto;">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <script>
        function showStudentManagementModal() {
            document.getElementById('studentManagementModal').classList.add('active');
            renderStudentListInModal();
        }

        async function renderStudentListInModal() {
            const listContainer = document.getElementById('studentsListModalContainer');
            // Use auth.getStudents() to respect Teacher filtering
            const students = await auth.getStudents();

            if (students.length === 0) {
                listContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let html = '<div class="grid grid-2" style="gap: 1rem;">';
            students.forEach(s => {
                html += `
                     <div class="card" style="padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
                         <div>
                             <div style="font-weight: bold; font-size: 1.1rem;">${s.name}</div>
                             <div style="color: #666; font-size: 0.9rem;">ID: ${s.username}</div>
                             <div style="color: #999; font-size: 0.8rem;">PW: ${s.password}</div> 
                         </div>
                         <div style="display: flex; gap: 5px;">
                            <button class="btn btn-outline btn-sm" onclick="showEditStudentModal('${s.username}')">ìˆ˜ì •</button>
                            <button class="btn btn-outline btn-sm" style="color: #e00; border-color: #e00;" onclick="deleteStudent('${s.username}')">ì‚­ì œ</button>
                         </div>
                     </div>
                 `;
            });
            html += '</div>';
            listContainer.innerHTML = html;
        }

        // CSV Functions
        function toggleStudentCsv() {
            const section = document.getElementById('studentCsvSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        async function processStudentCsv() {
            const input = document.getElementById('studentCsvInput').value.trim();
            if (!input) return;

            const lines = input.split('\n');
            let successCount = 0;
            let failCount = 0;

            if (!confirm(`${lines.length}ëª…ì˜ í•™ìƒì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            for (const line of lines) {
                if (!line.trim()) continue;
                // Format: Name, ID, PW, Grade
                const parts = line.split(',').map(p => p.trim());
                if (parts.length < 4) {
                    console.warn('Invalid format:', line);
                    failCount++;
                    continue;
                }

                const [name, username, password, grade] = parts;

                try {
                    // Check if exists? auth.createStudent handles creation.
                    // But duplicates might error or overwrite depending on impl. 
                    // createStudent creates unique ID but saves username. 
                    // dbService.saveUser merges if ID exists.
                    // But here we are creating NEW students.
                    // We need to check if username exists? 
                    // auth.createStudent doesn't check username uniqueness explicitly yet, but let's assume valid.

                    const result = await auth.createStudent({
                        name,
                        username,
                        password,
                        grade
                    });

                    if (result) successCount++;
                    else failCount++;
                } catch (e) {
                    console.error(e);
                    failCount++;
                }
            }

            alert(`ë“±ë¡ ì™„ë£Œ: ì„±ê³µ ${successCount}ëª…, ì‹¤íŒ¨ ${failCount}ëª…`);
            document.getElementById('studentCsvInput').value = '';
            toggleStudentCsv(); // Close panel
            renderStudentListInModal(); // Refresh list
            loadDashboard(); // Update stats
        }

        var originalDeleteStudent = window.deleteStudent;
        window.deleteStudent = async function (username) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            // Use auth system to delete
            await auth.deleteStudent(username);

            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            renderStudentListInModal();
            loadDashboard(); // Update stats
        };
    </script>
    <!-- CSV Generator Modal -->
    <div class="modal-overlay" id="csvGenModal">
        <div class="modal" style="position: relative; max-width: 900px;">
            <button class="modal-close" onclick="closeCsvGeneratorModal()">Ã—</button>
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“ CSV ë°ì´í„° ìƒì„±ê¸°</h2>
                <p style="color: #666;">ë‹¨ì–´ ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ ëŒ€ëŸ‰ ì¶”ê°€ìš© CSV ì½”ë“œë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.</p>
            </div>

            <div class="grid grid-2" style="gap: 2rem; align-items: start;">
                <!-- Input Form -->
                <div>
                    <h4 class="mb-3">ì…ë ¥ ì–‘ì‹</h4>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" id="genWord" class="form-input" placeholder="ë‹¨ì–´ (ì˜ˆ: í•™êµ)" style="flex:1;"
                                onkeydown="if(event.key === 'Enter') autoFillVocabInfo()">
                            <button onclick="autoFillVocabInfo()" class="btn btn-outline" style="white-space: nowrap;">
                                ğŸ” ê²€ìƒ‰/ì±„ìš°ê¸°
                            </button>
                        </div>
                        <input type="text" id="genHanja" class="form-input mb-2" placeholder="í•œì (ì˜ˆ: å­¸æ ¡)">
                        <input type="text" id="genMeaning" class="form-input mb-2" placeholder="ëœ» (ì˜ˆ: ë°°ìš°ëŠ” ê³³)">
                        <div class="grid grid-2" style="gap: 0.5rem; margin-bottom: 0.5rem;">
                            <select id="genGrade" class="form-input">
                                <option value="1">1í•™ë…„</option>
                                <option value="2">2í•™ë…„</option>
                                <option value="3">3í•™ë…„</option>
                                <option value="4">4í•™ë…„</option>
                                <option value="5">5í•™ë…„</option>
                                <option value="6">6í•™ë…„</option>
                            </select>
                            <input type="text" id="genCategory" class="form-input" placeholder="ì¹´í…Œê³ ë¦¬ (ì˜ˆ: ìƒí™œ)">
                        </div>
                        <textarea id="genExamples" class="form-input mb-2" style="height: 60px;"
                            placeholder="ì˜ˆë¬¸ (ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ê°œ)"></textarea>

                        <button onclick="addCsvGenItem()" class="btn btn-primary" style="width: 100%;">
                            â¬‡ï¸ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                        </button>
                    </div>
                </div>

                <!-- Output Area -->
                <div>
                    <h4 class="mb-3">ìƒì„±ëœ CSV ë°ì´í„°</h4>
                    <textarea id="csvGenOutput" class="form-input"
                        style="height: 200px; font-family: monospace; background: #333; color: #fff;"
                        readonly></textarea>

                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button onclick="copyCsvGenOutput()" class="btn btn-success" style="flex: 1;">
                            ğŸ“‹ ë³µì‚¬í•˜ê¸°
                        </button>
                        <button onclick="resetCsvGen()" class="btn btn-outline"
                            style="color: #e00; border-color: #e00;">
                            ì´ˆê¸°í™”
                        </button>
                    </div>

                    <div class="mt-3">
                        <h4 style="font-size: 0.9rem;">ì¶”ê°€ëœ ëª©ë¡ (<span id="genCount">0</span>ê°œ)</h4>
                        <div id="genPreviewList"
                            style="max-height: 150px; overflow-y: auto; font-size: 0.8rem; border: 1px solid #eee; padding: 0.5rem;">
                            <!-- Items -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let generatedItems = [];

        function showCsvGeneratorModal() {
            document.getElementById('csvGenModal').classList.add('active');
        }

        function closeCsvGeneratorModal() {
            document.getElementById('csvGenModal').classList.remove('active');
        }

        function addCsvGenItem() {
            const word = document.getElementById('genWord').value.trim();
            const hanja = document.getElementById('genHanja').value.trim();
            const meaning = document.getElementById('genMeaning').value.trim();
            const grade = document.getElementById('genGrade').value;
            const category = document.getElementById('genCategory').value.trim() || 'ê¸°íƒ€';
            const examplesRaw = document.getElementById('genExamples').value.trim();

            if (!word || !meaning) {
                alert("ë‹¨ì–´ì™€ ëœ»ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                return;
            }

            const examplesStr = examplesRaw ? examplesRaw.split('\n').map(e => e.trim()).filter(e => e).join('|') : '';

            // Format: Word, Hanja, Meaning, Grade, Category, Examples
            const csvLine = `${word}, ${hanja}, ${meaning}, ${grade}, ${category}, ${examplesStr}`;

            generatedItems.push({
                display: `${word} (${meaning})`,
                csv: csvLine
            });

            updateCsvGenUI();

            // Clear inputs (except grade/category maybe?)
            document.getElementById('genWord').value = '';
            document.getElementById('genHanja').value = '';
            document.getElementById('genMeaning').value = '';
            document.getElementById('genExamples').value = '';
            document.getElementById('genWord').focus();
        }

        function updateCsvGenUI() {
            const output = document.getElementById('csvGenOutput');
            const list = document.getElementById('genPreviewList');
            const count = document.getElementById('genCount');

            output.value = generatedItems.map(item => item.csv).join('\n');
            count.textContent = generatedItems.length;

            list.innerHTML = generatedItems.map((item, idx) => `
                <div style="border-bottom: 1px solid #eee; padding: 2px;">
                    ${idx + 1}. ${item.display}
                </div>
            `).join('');
        }

        function copyCsvGenOutput() {
            const output = document.getElementById('csvGenOutput');
            output.select();
            document.execCommand('copy');
            alert("í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n'ìƒˆ ì–´íœ˜ ì¶”ê°€' ë©”ë‰´ì˜ CSV ì…ë ¥ë€ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!");
        }

        function resetCsvGen() {
            if (confirm("ì‘ì„±ëœ ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                generatedItems = [];
                updateCsvGenUI();
            }
        }

        // Global dictionary cache
        let externalDict = null;
        let isDictLoading = false;

        async function loadExternalDictionary() {
            if (externalDict || isDictLoading) return;
            isDictLoading = true;

            try {
                showFeedback("ğŸ“š ì‚¬ì „ ë°ì´í„° ë¡œë”©ì¤‘...");
                const response = await fetch('../js/kengdic.tsv');
                if (!response.ok) throw new Error('Network response was not ok');
                const text = await response.text();

                externalDict = {};
                const lines = text.split('\n');
                // Skip header
                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split('\t');
                    if (parts.length >= 4) {
                        const word = parts[1].trim();
                        const hanja = parts[2].trim();
                        const gloss = parts[3].trim();

                        if (!externalDict[word] || (!externalDict[word].hanja && hanja)) {
                            externalDict[word] = { hanja, gloss };
                        }
                    }
                }
                console.log("Dictionary loaded, entries:", Object.keys(externalDict).length);
                showFeedback("ğŸ“š ì‚¬ì „ ë¡œë”© ì™„ë£Œ!");
            } catch (err) {
                console.error("Failed to load dictionary:", err);
                showFeedback("âŒ ì‚¬ì „ ë¡œë”© ì‹¤íŒ¨");
            } finally {
                isDictLoading = false;
            }
        }

        function autoFillVocabInfo() {
            const word = document.getElementById('genWord').value.trim();
            if (!word) return;

            // Trigger dictionary load if not ready (background)
            if (!externalDict) loadExternalDictionary();

            // 1. Search in Active vocabDB
            let found = vocabDB.vocabulary.find(v => v.word === word);

            // 1-2. If not in active DB, search in the Full Reference Dictionary (Code Base)
            if (!found) {
                const fullList = vocabDB.getSampleVocabulary();
                console.log("Checking sample vocab:", fullList.length);
                found = fullList.find(v => v.word === word);
                if (found) {
                    showFeedback("ğŸ“š ì‚¬ì „ì—ì„œ ì°¾ìŒ");
                }
            } else {
                showFeedback("âœ… ë‚´ ë‹¨ì–´ì¥ì—ì„œ ì°¾ìŒ");
            }

            if (found) {
                document.getElementById('genHanja').value = found.hanja || '';
                document.getElementById('genMeaning').value = found.meaning || '';
                document.getElementById('genGrade').value = found.grade || '1';
                document.getElementById('genCategory').value = found.category || '';
                if (found.examples && found.examples.length > 0) {
                    document.getElementById('genExamples').value = found.examples.join('\n');
                }
                return;
            }

            // 2. Search in External Dictionary (Kengdic)
            let extData = externalDict ? externalDict[word] : null;
            let foundUnknownHanja = null;

            if (extData) {
                if (extData.hanja) {
                    document.getElementById('genHanja').value = extData.hanja;
                    foundUnknownHanja = extData.hanja;
                }
                if (extData.gloss) {
                    document.getElementById('genMeaning').value = `(ì˜) ${extData.gloss}`;
                }
                showFeedback("ğŸ“– ì™¸ë¶€ ì‚¬ì „ì—ì„œ ì°¾ìŒ");
            }

            // 3. Search in hanjaCompounds (Reverse Lookup) if Hanja still missing
            if (!foundUnknownHanja && typeof hanjaCompounds !== 'undefined') {
                const searchStr = `${word} (`;
                for (const key in hanjaCompounds) {
                    const list = hanjaCompounds[key];
                    const match = list.find(item => item.startsWith(searchStr));
                    if (match) {
                        const regex = /\((.+)\)/;
                        const m = match.match(regex);
                        if (m && m[1]) {
                            foundUnknownHanja = m[1];
                            document.getElementById('genHanja').value = foundUnknownHanja;
                            break;
                        }
                    }
                }
            }

            // Generate Meaning from Hanja definitions if Hanja found but Meaning empty
            if (foundUnknownHanja) {
                if (!document.getElementById('genMeaning').value && typeof hanjaDic !== 'undefined' && foundUnknownHanja.length === word.length) {
                    let meaningParts = [];
                    for (let i = 0; i < word.length; i++) {
                        const hChar = foundUnknownHanja[i];
                        const wChar = word[i];
                        const entries = hanjaDic[hChar];
                        if (entries) {
                            const entry = entries.find(e => e.kor === wChar) || entries[0];
                            meaningParts.push(`${entry.def} ${wChar}`);
                        }
                    }
                    if (meaningParts.length > 0) {
                        const hanjaMeaning = `[í•œìí’€ì´] ${meaningParts.join(', ')}`;
                        // If existing value (e.g. from Kengdic), append. Else set.
                        if (document.getElementById('genMeaning').value) {
                            document.getElementById('genMeaning').value += ` / ${hanjaMeaning}`;
                        } else {
                            document.getElementById('genMeaning').value = hanjaMeaning;
                        }
                    }
                }

                showFeedback("âš ï¸ í•œì/ëœ» ìë™ì™„ì„±");
                return;
            }


            // 4. Fallback: Suggest Hanja from hanjaDic (Char by Char)
            if (!document.getElementById('genHanja').value && typeof hanjaDic !== 'undefined') {
                let suggestedHanja = "";
                let possible = true;
                for (let char of word) {
                    let candidates = [];
                    for (let [h, defs] of Object.entries(hanjaDic)) {
                        if (defs.some(d => d.kor === char)) candidates.push(h);
                    }
                    if (candidates.length > 0) suggestedHanja += candidates[0];
                    else possible = false;
                }
                if (possible && suggestedHanja.length === word.length) {
                    document.getElementById('genHanja').value = suggestedHanja + " (?)";
                    showFeedback("âš ï¸ í•œì ì¶”ì •ë¨");
                } else {
                    alert(`'${word}'ì— ëŒ€í•œ ì •ë³´ë¥¼ DB ë° ì‚¬ì „ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                    document.getElementById('genHanja').focus();
                }
                return;
            }

            if (document.getElementById('genHanja').value && !document.getElementById('genMeaning').value) {
                document.getElementById('genMeaning').focus();
                showFeedback("âš ï¸ í•œì ì°¾ìŒ (ëœ» ì…ë ¥ í•„ìš”)");
            }

            // Generate 10 Generic Examples if missing
            if (!document.getElementById('genExamples').value) {
                const josa = getKoreanParticles(word);
                const examples = [
                    `ë‚˜ëŠ” ${word}${josa.ul} ì¢‹ì•„í•©ë‹ˆë‹¤.`,
                    `${word}${josa.nun} ì •ë§ ì¤‘ìš”í•©ë‹ˆë‹¤.`,
                    `ìš°ë¦¬ëŠ” í•™êµì—ì„œ ${word}ì— ëŒ€í•´ ë°°ì› ìŠµë‹ˆë‹¤.`,
                    `${word}ì˜ ëœ»ì€ ë¬´ì—‡ì¼ê¹Œìš”?`,
                    `${word}${josa.ul} ì‚¬ìš©í•˜ì—¬ ë¬¸ì¥ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”.`,
                    `${word}${josa.nun} ìš°ë¦¬ ìƒí™œê³¼ ê´€ë ¨ì´ ìˆìŠµë‹ˆë‹¤.`,
                    `ì¹œêµ¬ì™€ í•¨ê»˜ ${word}ì— ëŒ€í•´ ì´ì•¼ê¸°í–ˆìŠµë‹ˆë‹¤.`,
                    `${word}${josa.ul} ìŠì§€ ì•Šë„ë¡ ë…¸ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.`,
                    `ì±…ì—ì„œ ${word}ë¼ëŠ” ë§ì„ ë³´ì•˜ìŠµë‹ˆë‹¤.`,
                    `${word}${josa.nun} í•œìë¡œ ì–´ë–»ê²Œ ì“¸ê¹Œìš”?`
                ];
                document.getElementById('genExamples').value = examples.join('\n');
            }
        }

        function getKoreanParticles(word) {
            const lastChar = word.charCodeAt(word.length - 1);
            const hasJongseong = (lastChar - 0xAC00) % 28 > 0;
            return {
                ul: hasJongseong ? 'ì„' : 'ë¥¼',
                nun: hasJongseong ? 'ì€' : 'ëŠ”',
                i: hasJongseong ? 'ì´' : 'ê°€',
                wa: hasJongseong ? 'ê³¼' : 'ì™€'
            };
        }


        function showFeedback(msg) {
            const btn = document.querySelector('button[onclick="autoFillVocabInfo()"]');
            const originalText = btn.innerText;
            btn.innerText = msg;
            setTimeout(() => btn.innerText = originalText, 1500);
        }
    </script>
    <script>
        // --- Settings Management Logic ---

        function showSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
            loadSettingsToForm();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function loadSettingsToForm() {
            const user = auth.getCurrentUser();
            const settings = user.settings || {};

            document.getElementById('settingSchoolName').value = settings.schoolName || '';
            document.getElementById('settingClassName').value = settings.className || '';
            document.getElementById('settingDefaultGrade').value = settings.defaultGrade || '';
        }

        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const updates = {
                settings: {
                    schoolName: document.getElementById('settingSchoolName').value.trim(),
                    className: document.getElementById('settingClassName').value.trim(),
                    defaultGrade: document.getElementById('settingDefaultGrade').value
                }
            };

            try {
                // auth.updateUser is the method we added to auth.js
                await auth.updateUser(updates);
                alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeSettingsModal();
                applySettings(); // Refresh view
            } catch (e) {
                console.error(e);
                alert('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // Apply settings to Dashboard UI
        function applySettings() {
            const user = auth.getCurrentUser();
            if (!user || !user.settings) return;

            // 1. Update Welcome Info
            const welcomeMsg = document.getElementById('welcomeMessage');
            let infoText = "";
            if (user.settings.schoolName) infoText += user.settings.schoolName + " ";
            if (user.settings.className) infoText += user.settings.className + " ";

            // If we have custom school/class info, append it or replace
            // Current text: "Welcome, Name!"
            // We can change it to: "Welcome, Name! (School Class)"
            if (infoText) {
                // Check if already applied to avoid duplication if called multiple times?
                // Just reset simple template.
                welcomeMsg.textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${user.name} ì„ ìƒë‹˜! (${infoText.trim()}) ğŸ‘‹`;
            }

            // 2. Pre-select Defaults in Dropdowns (if they exist on page)
            const defGrade = user.settings.defaultGrade;
            if (defGrade) {
                const addStudentGrade = document.getElementById('studentGrade');
                if (addStudentGrade && !addStudentGrade.value) addStudentGrade.value = defGrade;

                const worksheetGrade = document.getElementById('worksheetGrade');
                // Only if "All Grades" (empty) is selected, or force?
                // Usually force default on load.
                if (worksheetGrade && worksheetGrade.value === "") {
                    worksheetGrade.value = defGrade;
                    // Trigger change event if needed
                    if (typeof updateWorksheetVocabList === 'function') updateWorksheetVocabList();
                }

                const quizGrade = document.getElementById('quizGrade');
                if (quizGrade && quizGrade.value === "") {
                    quizGrade.value = defGrade;
                    if (typeof updateQuizVocabList === 'function') updateQuizVocabList();
                }

                const dailyPlanGrade = document.getElementById('planGrade');
                // DailyPlan defaults to 3 in showDailyPlanModal, let's override logic there or here?
                // showDailyPlanModal calls `planGrade.value = '3'`. I should modify `showDailyPlanModal` to check settings.
            }
        }

        // Hook into initialization
        // We need to call applySettings() after loadDashboard or on page load.
        // Since this script runs at end of body, auth.init might be async.
        // We can hook into window load or just call it if auth is ready.
        // Auth is sync-ish for getCurrentUser if loaded from localStorage.

        // Let's add a safe check
        if (auth.isLoggedIn()) {
            applySettings();
        }

        // Modify existing functions to use settings?
        // showDailyPlanModal specific override:
        const originalShowDailyPlan = window.showDailyPlanModal;
        window.showDailyPlanModal = function () {
            document.getElementById('dailyPlanModal').classList.add('active');

            const user = auth.getCurrentUser();
            const defGrade = (user.settings && user.settings.defaultGrade) ? user.settings.defaultGrade : '3';

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('planDate').value = today;
            document.getElementById('planGrade').value = defGrade;

            loadPlanForEditor();
        };

    </script>
</body>

</html>